<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenBudget - Zero-Based Expense Tracker</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            /* Light Mode Defaults */
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            
            --radius: 8px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --blur-amount: 0px;
        }

        /* Dark Mode Overrides */
        body.dark-mode {
            --primary: #3b82f6;
            --primary-dark: #60a5fa;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-input: #374151;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Privacy Mode */
        body.privacy-mode { --blur-amount: 6px; }
        .private-data { filter: blur(var(--blur-amount)); transition: filter 0.3s; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg-body); color: var(--text-main); line-height: 1.5; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }

        /* --- LAYOUT & UTILS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card { background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); transition: background-color 0.3s; }
        .flex { display: flex; align-items: center; }
        .flex-between { justify-content: space-between; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .hidden { display: none !important; }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3 { font-weight: 600; color: var(--text-main); }
        h1 { font-size: 1.5rem; }
        .text-sm { font-size: 0.875rem; color: var(--text-muted); }
        .text-xl { font-size: 1.5rem; font-weight: 700; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }

        /* --- BUTTONS & INPUTS --- */
        button, .btn {
            cursor: pointer; padding: 0.5rem 1rem; border-radius: var(--radius); border: none; font-weight: 500; transition: all 0.2s; font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--bg-body); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        
        input, select {
            width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; 
            background: var(--bg-input); color: var(--text-main); transition: background 0.3s, color 0.3s;
        }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* --- NAVIGATION --- */
        header { background: var(--bg-card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; transition: background-color 0.3s; }
        nav { display: flex; gap: 1rem; overflow-x: auto; padding-top: 1rem; }
        .nav-item {
            padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-muted); white-space: nowrap;
        }
        .nav-item.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
        .nav-item:hover { color: var(--text-main); }

        /* --- COMPONENTS --- */
        /* Progress Bars */
        .progress-track { background: var(--bg-body); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }
        .bg-green { background: var(--success); }
        .bg-yellow { background: var(--warning); }
        .bg-red { background: var(--danger); }
        .bg-primary { background: var(--primary); }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-body); font-weight: 600; font-size: 0.85rem; color: var(--text-muted); }
        tr:last-child td { border-bottom: none; }

        /* Fab Button (Mobile) */
        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 90;
        }

        /* Modal */
        dialog {
            border: none; border-radius: var(--radius); padding: 0; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 500px; width: 90%; margin: auto; background: var(--bg-card); color: var(--text-main);
        }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; background: var(--bg-body); display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* Category Tag */
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-needs { background: #dbeafe; color: #1e40af; }
        .badge-wants { background: #fce7f3; color: #9d174d; }
        .badge-savings { background: #d1fae5; color: #065f46; }
        
        /* Dark Mode Badges adjustment */
        body.dark-mode .badge-needs { background: #1e3a8a; color: #dbeafe; }
        body.dark-mode .badge-wants { background: #831843; color: #fce7f3; }
        body.dark-mode .badge-savings { background: #064e3b; color: #d1fae5; }
        
        /* Unassigned Money Box */
        .box-highlight { background: #eef2ff; border-radius: 8px; padding: 1rem; }
        body.dark-mode .box-highlight { background: #374151; }

        /* Charts (CSS Only) */
        .chart-bar-container { display: flex; align-items: flex-end; height: 150px; gap: 4px; padding-top: 20px;}
        .chart-col { flex: 1; background: var(--primary); border-radius: 4px 4px 0 0; position: relative; min-height: 2px; transition: height 0.3s; opacity: 0.8;}
        .chart-col:hover { opacity: 1; }
        .chart-label { position: absolute; bottom: -25px; left: 0; right: 0; text-align: center; font-size: 10px; color: var(--text-muted); }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <div class="flex flex-between">
                <div class="flex gap-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <h1>ZenBudget</h1>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-outline btn-sm" id="toggleTheme" title="Toggle Dark Mode">üåô</button>
                    <button class="btn btn-outline btn-sm" id="togglePrivacy" title="Toggle Privacy Mode">üëÅÔ∏è Privacy</button>
                    <button class="btn btn-outline btn-sm" id="exportBtn">‚¨á CSV</button>
                </div>
            </div>
            <nav>
                <div class="nav-item active" data-tab="dashboard">Dashboard</div>
                <div class="nav-item" data-tab="transactions">Transactions</div>
                <div class="nav-item" data-tab="planning">Planning</div>
                <div class="nav-item" data-tab="insights">Insights</div>
            </nav>
        </div>
    </header>

    <main class="container mt-4">
        
        <section id="dashboard" class="view">
            <div class="grid grid-4 mb-4">
                <div class="card">
                    <div class="text-sm">Total Spent (Month)</div>
                    <div class="text-xl private-data" id="dashTotalSpent">‚Ç±0.00</div>
                </div>
                <div class="card">
                    <div class="text-sm">Remaining Budget</div>
                    <div class="text-xl private-data" id="dashRemaining">‚Ç±0.00</div>
                </div>
                <div class="card">
                    <div class="text-sm">Savings Rate</div>
                    <div class="text-xl private-data" id="dashSavingsRate">0%</div>
                </div>
                <div class="card">
                    <div class="text-sm">Net Balance</div>
                    <div class="text-xl private-data" id="dashNet">‚Ç±0.00</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h3>Budget Status</h3>
                    <div id="budgetBars" class="mt-4 grid gap-4">
                    </div>
                </div>
                <div class="card">
                    <h3>Recent Transactions</h3>
                    <div id="recentList" class="mt-4 grid gap-2">
                    </div>
                </div>
            </div>
        </section>

        <section id="transactions" class="view hidden">
            <div class="card">
                <div class="flex flex-between mb-4" style="margin-bottom: 1rem;">
                    <input type="text" id="searchTx" placeholder="Search description..." style="max-width: 300px;">
                    <select id="filterCategory" style="max-width: 200px;">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Group</th>
                                <th class="text-right">Amount</th>
                                <th class="text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="txTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="planning" class="view hidden">
            <div class="grid grid-2">
                <div class="card">
                    <h3>Budget Configuration</h3>
                    <p class="text-sm mb-4">Set monthly limits. Zero-based budgeting: Assign every peso.</p>
                    <div class="flex flex-between mb-4">
                         <span>Expected Income:</span>
                         <input type="number" id="monthlyIncome" value="0" style="width: 150px; text-align: right;">
                    </div>
                    <div id="categoryInputs">
                    </div>
                    <div class="mt-4 box-highlight">
                        <div class="flex flex-between">
                            <strong>Unassigned Money:</strong>
                            <strong id="unassignedMoney" class="private-data">‚Ç±0.00</strong>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Add New Category</h3>
                    <form id="addCategoryForm" class="flex flex-col gap-4 mt-4">
                        <input type="text" id="newCatName" placeholder="Category Name (e.g., Gym)" required>
                        <select id="newCatGroup">
                            <option value="needs">Needs (Fixed)</option>
                            <option value="wants">Wants (Variable)</option>
                            <option value="savings">Savings / Debt</option>
                        </select>
                        <button type="submit" class="btn btn-primary">Create Category</button>
                    </form>
                </div>
            </div>
        </section>

        <section id="insights" class="view hidden">
            <div class="grid grid-2">
                <div class="card">
                    <h3>Spending by Group</h3>
                    <div id="groupBreakdown" class="mt-4">
                    </div>
                </div>
                <div class="card">
                    <h3>Last 6 Months (Total Outflow)</h3>
                    <div id="trendChart" class="chart-bar-container">
                    </div>
                </div>
            </div>
        </section>
    </main>

    <button class="fab" id="openAddTxModal" aria-label="Add transaction">+</button>

    <dialog id="txModal">
        <form id="txForm">
            <div class="modal-header">
                <h3>Add Transaction</h3>
                <button type="button" class="btn-outline" style="border:none;" onclick="document.getElementById('txModal').close()" aria-label="Close">‚úï</button>
            </div>
            <div class="modal-body grid gap-4">
                <div class="flex gap-2">
                    <button type="button" class="btn btn-primary flex-1" id="typeExpense">Expense</button>
                    <button type="button" class="btn btn-outline flex-1" id="typeIncome">Income</button>
                </div>
                <input type="hidden" id="txType" value="expense">
                
                <div>
                    <label class="text-sm" for="txAmount">Amount</label>
                    <input type="number" id="txAmount" step="0.01" required placeholder="0.00" min="0.01">
                </div>
                <div>
                    <label class="text-sm" for="txDate">Date</label>
                    <input type="date" id="txDate" required>
                </div>
                <div>
                    <label class="text-sm" for="txDesc">Description</label>
                    <input type="text" id="txDesc" required placeholder="e.g. Grocery Store" maxlength="200">
                </div>
                <div id="categorySelectContainer">
                    <label class="text-sm" for="txCategory">Category</label>
                    <select id="txCategory" required>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="document.getElementById('txModal').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </dialog>

    <script>
        /**
         * APPLICATION ARCHITECTURE
         * 1. Store: Manages State and localStorage
         * 2. Utils: Formatting and Helpers
         * 3. App: Logic, Event Listeners, and UI Rendering
         */

        /* --- 1. STORE (Data Management) --- */
        const Store = {
            state: {
                transactions: [],
                categories: [
                    { id: 'c1', name: 'Rent/Mortgage', group: 'needs', limit: 15000 },
                    { id: 'c2', name: 'Groceries', group: 'needs', limit: 5000 },
                    { id: 'c3', name: 'Utilities', group: 'needs', limit: 2000 },
                    { id: 'c4', name: 'Dining Out', group: 'wants', limit: 1500 },
                    { id: 'c5', name: 'Entertainment', group: 'wants', limit: 1000 },
                    { id: 'c6', name: 'Emergency Fund', group: 'savings', limit: 3000 }
                ],
                income: 30000,
                privacyMode: false,
                theme: 'light'
            },

            init() {
                try {
                    const saved = localStorage.getItem('zenbudget_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.state = { ...this.state, ...parsed };
                    }
                } catch (error) {
                    console.error('Failed to load data:', error);
                    alert('Failed to load saved data. Starting fresh.');
                }
            },

            save() {
                try {
                    localStorage.setItem('zenbudget_data', JSON.stringify(this.state));
                } catch (error) {
                    console.error('Failed to save data:', error);
                    if (error.name === 'QuotaExceededError') {
                        alert('Storage quota exceeded. Consider exporting and clearing old data.');
                    } else {
                        alert('Failed to save data. Changes may be lost.');
                    }
                }
                App.render();
            },

            addTransaction(tx) {
                if (!tx.amount || !tx.date || !tx.desc || !tx.type) {
                    console.error('Invalid transaction data');
                    return false;
                }
                
                this.state.transactions.push({ 
                    ...tx, 
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    amount: Utils.roundMoney(tx.amount)
                });
                this.save();
                return true;
            },

            deleteTransaction(id) {
                this.state.transactions = this.state.transactions.filter(t => t.id !== id);
                this.save();
            },

            addCategory(name, group) {
                this.state.categories.push({ 
                    id: 'c' + Date.now().toString(), 
                    name, 
                    group, 
                    limit: 0 
                });
                this.save();
            },

            updateBudgetLimit(id, limit) {
                const cat = this.state.categories.find(c => c.id === id);
                const parsedLimit = parseFloat(limit);
                
                if (isNaN(parsedLimit) || parsedLimit < 0) {
                    alert('Budget limit must be a positive number');
                    return false;
                }
                if (parsedLimit > 999999999) {
                    alert('Budget limit is too large');
                    return false;
                }
                
                if (cat) cat.limit = Utils.roundMoney(parsedLimit);
                this.save();
                return true;
            },
            
            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                this.save();
                return this.state.theme;
            }
        };

        /* --- 2. UTILS --- */
        const Utils = {
            roundMoney: (num) => Math.round((num + Number.EPSILON) * 100) / 100,
            
            fmtMoney: (num) => new Intl.NumberFormat('en-PH', { 
                style: 'currency', 
                currency: 'PHP',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2 
            }).format(num),
            
            fmtDate: (str) => new Date(str).toLocaleDateString('en-PH'),
            
            isCurrentMonth: (dateStr) => {
                const d = new Date(dateStr);
                const now = new Date();
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            },
            
            groupBy: (arr, key) => arr.reduce((acc, item) => ((acc[item[key]] = [...(acc[item[key]] || []), item]), acc), {}),
            
            getCategoryById: (id) => Store.state.categories.find(c => c.id === id),
            
            getCategoryName: (id) => {
                const cat = Utils.getCategoryById(id);
                return cat ? cat.name : 'Uncategorized';
            },
            
            sanitize: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        };

        /* --- 3. APP (Controller & UI) --- */
        const App = {
            init() {
                Store.init();
                
                // Set Theme immediately
                if (Store.state.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('toggleTheme').textContent = '‚òÄÔ∏è';
                }
                
                // Set Privacy Mode
                if (Store.state.privacyMode) {
                    document.body.classList.add('privacy-mode');
                }

                // Set Default Date in Modal
                document.getElementById('txDate').valueAsDate = new Date();

                this.bindEvents();
                this.render();
            },

            bindEvents() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.remove('hidden');
                    });
                });

                // Modals
                document.getElementById('openAddTxModal').addEventListener('click', () => {
                    document.getElementById('txForm').reset();
                    document.getElementById('txDate').valueAsDate = new Date();
                    const modal = document.getElementById('txModal');
                    modal.showModal();
                    // Focus first input for accessibility
                    setTimeout(() => document.getElementById('txAmount').focus(), 100);
                });
                
                // ESC key handler for modal
                document.getElementById('txModal').addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        e.target.close();
                    }
                });

                // Form: Add Transaction
                document.getElementById('txForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const type = document.getElementById('txType').value;
                    const amount = parseFloat(document.getElementById('txAmount').value);
                    const date = document.getElementById('txDate').value;
                    const desc = document.getElementById('txDesc').value.trim();
                    
                    // Validation
                    if (isNaN(amount) || amount <= 0) {
                        alert('Amount must be a positive number');
                        return;
                    }
                    if (amount > 999999999) {
                        alert('Amount is too large');
                        return;
                    }
                    if (!desc) {
                        alert('Description is required');
                        return;
                    }
                    if (new Date(date) > new Date()) {
                        const proceed = confirm('This date is in the future. Continue?');
                        if (!proceed) return;
                    }
                    
                    const success = Store.addTransaction({
                        date: date,
                        desc: desc,
                        category: type === 'income' ? null : document.getElementById('txCategory').value,
                        amount: type === 'expense' ? -amount : amount, // Expenses negative, income positive
                        type: type
                    });
                    
                    if (success) {
                        document.getElementById('txModal').close();
                    }
                });

                // Transaction Type Toggle
                const btnExp = document.getElementById('typeExpense');
                const btnInc = document.getElementById('typeIncome');
                btnExp.addEventListener('click', () => {
                    btnExp.classList.add('btn-primary'); 
                    btnExp.classList.remove('btn-outline');
                    btnInc.classList.add('btn-outline'); 
                    btnInc.classList.remove('btn-primary');
                    document.getElementById('txType').value = 'expense';
                    document.getElementById('categorySelectContainer').classList.remove('hidden');
                });
                btnInc.addEventListener('click', () => {
                    btnInc.classList.add('btn-primary'); 
                    btnInc.classList.remove('btn-outline');
                    btnExp.classList.add('btn-outline'); 
                    btnExp.classList.remove('btn-primary');
                    document.getElementById('txType').value = 'income';
                    document.getElementById('categorySelectContainer').classList.add('hidden');
                });

                // Search & Filter
                const filterHandler = () => this.renderTransactions();
                document.getElementById('searchTx').addEventListener('input', filterHandler);
                document.getElementById('filterCategory').addEventListener('change', filterHandler);

                // Privacy Toggle
                document.getElementById('togglePrivacy').addEventListener('click', () => {
                    Store.state.privacyMode = !Store.state.privacyMode;
                    document.body.classList.toggle('privacy-mode', Store.state.privacyMode);
                    Store.save();
                });
                
                // Theme Toggle
                document.getElementById('toggleTheme').addEventListener('click', (e) => {
                   const newTheme = Store.toggleTheme();
                   if (newTheme === 'dark') {
                       document.body.classList.add('dark-mode');
                       e.target.textContent = '‚òÄÔ∏è';
                   } else {
                       document.body.classList.remove('dark-mode');
                       e.target.textContent = 'üåô';
                   }
                });

                // Export
                document.getElementById('exportBtn').addEventListener('click', this.exportCSV);

                // Planning Inputs
                document.getElementById('monthlyIncome').addEventListener('change', (e) => {
                    const income = parseFloat(e.target.value);
                    if (isNaN(income) || income < 0) {
                        alert('Income must be a positive number');
                        e.target.value = Store.state.income;
                        return;
                    }
                    if (income > 999999999) {
                        alert('Income value is too large');
                        e.target.value = Store.state.income;
                        return;
                    }
                    Store.state.income = Utils.roundMoney(income);
                    Store.save();
                });

                // Add Category
                document.getElementById('addCategoryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('newCatName').value.trim();
                    if (!name) {
                        alert('Category name is required');
                        return;
                    }
                    Store.addCategory(
                        name,
                        document.getElementById('newCatGroup').value
                    );
                    document.getElementById('addCategoryForm').reset();
                });
            },

            render() {
                this.renderDashboard();
                this.renderTransactions();
                this.renderPlanning();
                this.renderInsights();
                this.updateCategoryDropdowns();
            },

            getMetrics() {
                const currentTx = Store.state.transactions.filter(t => Utils.isCurrentMonth(t.date));
                const sortedTx = [...Store.state.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
                
                // Sum expenses (negative values, so use Math.abs)
                const totalSpent = Utils.roundMoney(
                    Math.abs(currentTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0))
                );
                
                // Sum income (positive values)
                const totalIncomeTx = Utils.roundMoney(
                    currentTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0)
                );
                
                const effectiveIncome = Utils.roundMoney(Store.state.income + totalIncomeTx); 
                const totalBudget = Utils.roundMoney(Store.state.categories.reduce((sum, c) => sum + c.limit, 0));

                return { currentTx, sortedTx, totalSpent, effectiveIncome, totalBudget };
            },

            renderDashboard() {
                const { currentTx, sortedTx, totalSpent, effectiveIncome, totalBudget } = this.getMetrics();
                
                document.getElementById('dashTotalSpent').textContent = Utils.fmtMoney(totalSpent);
                document.getElementById('dashRemaining').textContent = Utils.fmtMoney(effectiveIncome - totalSpent);
                document.getElementById('dashNet').textContent = Utils.fmtMoney(effectiveIncome - totalSpent);
                
                const savingsRate = effectiveIncome > 0 ? ((effectiveIncome - totalSpent) / effectiveIncome * 100).toFixed(1) : 0;
                document.getElementById('dashSavingsRate').textContent = savingsRate + '%';

                // Render Budget Progress Bars
                const container = document.getElementById('budgetBars');
                container.innerHTML = '';
                
                Store.state.categories.forEach(cat => {
                    const spent = Utils.roundMoney(
                        Math.abs(currentTx
                            .filter(t => t.type === 'expense' && t.category === cat.id)
                            .reduce((sum, t) => sum + t.amount, 0))
                    );
                    
                    if (cat.limit === 0 && spent === 0) return; 

                    const pct = cat.limit > 0 ? (spent / cat.limit) * 100 : (spent > 0 ? 100 : 0);
                    let colorClass = 'bg-green';
                    if (pct > 80) colorClass = 'bg-yellow';
                    if (pct > 100) colorClass = 'bg-red';

                    const div = document.createElement('div');
                    const labelEl = document.createElement('div');
                    labelEl.className = 'flex flex-between text-sm mb-1';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = cat.name;
                    
                    const amountSpan = document.createElement('span');
                    amountSpan.className = 'private-data';
                    amountSpan.textContent = `${Utils.fmtMoney(spent)} / ${Utils.fmtMoney(cat.limit)}`;
                    
                    labelEl.appendChild(nameSpan);
                    labelEl.appendChild(amountSpan);
                    
                    const progressTrack = document.createElement('div');
                    progressTrack.className = 'progress-track';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = `progress-fill ${colorClass}`;
                    progressFill.style.width = `${Math.min(pct, 100)}%`;
                    
                    progressTrack.appendChild(progressFill);
                    div.appendChild(labelEl);
                    div.appendChild(progressTrack);
                    container.appendChild(div);
                });

                // Recent Transactions
                const list = document.getElementById('recentList');
                list.innerHTML = '';
                const recent = sortedTx.slice(0, 5);
                
                recent.forEach(t => {
                    const catName = t.type === 'income' ? 'Income' : Utils.getCategoryName(t.category);
                    const div = document.createElement('div');
                    div.className = 'card flex flex-between';
                    div.style.padding = '0.75rem';
                    
                    const leftDiv = document.createElement('div');
                    const descDiv = document.createElement('div');
                    descDiv.style.fontWeight = 'bold';
                    descDiv.textContent = t.desc;
                    
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'text-sm';
                    detailDiv.textContent = `${Utils.fmtDate(t.date)} ‚Ä¢ ${catName}`;
                    
                    leftDiv.appendChild(descDiv);
                    leftDiv.appendChild(detailDiv);
                    
                    const amountDiv = document.createElement('div');
                    amountDiv.className = `${t.type === 'expense' ? 'text-danger' : 'text-success'} private-data`;
                    amountDiv.textContent = `${t.type === 'expense' ? '-' : '+'}${Utils.fmtMoney(Math.abs(t.amount))}`;
                    
                    div.appendChild(leftDiv);
                    div.appendChild(amountDiv);
                    list.appendChild(div);
                });
            },

            renderTransactions() {
                const tbody = document.getElementById('txTableBody');
                tbody.innerHTML = '';
                
                const search = document.getElementById('searchTx').value.toLowerCase();
                const filterCat = document.getElementById('filterCategory').value;

                const { sortedTx } = this.getMetrics();

                let txs = sortedTx.filter(t => {
                    const matchSearch = t.desc.toLowerCase().includes(search);
                    const matchCat = filterCat === 'all' || t.category === filterCat;
                    return matchSearch && matchCat;
                });

                txs.forEach(t => {
                    const cat = Utils.getCategoryById(t.category);
                    const row = document.createElement('tr');
                    
                    const dateCell = document.createElement('td');
                    dateCell.textContent = Utils.fmtDate(t.date);
                    
                    const descCell = document.createElement('td');
                    descCell.textContent = t.desc;
                    
                    const catCell = document.createElement('td');
                    catCell.textContent = t.type === 'income' ? 'Income' : (cat?.name || '-');
                    
                    const groupCell = document.createElement('td');
                    if (t.type === 'income') {
                        groupCell.textContent = '-';
                    } else {
                        const badge = document.createElement('span');
                        badge.className = `badge badge-${cat?.group}`;
                        badge.textContent = cat?.group || '';
                        groupCell.appendChild(badge);
                    }
                    
                    const amountCell = document.createElement('td');
                    amountCell.className = `text-right private-data ${t.type === 'expense' ? 'text-danger' : 'text-success'}`;
                    amountCell.textContent = `${t.type === 'expense' ? '-' : '+'}${Utils.fmtMoney(Math.abs(t.amount))}`;
                    
                    const actionCell = document.createElement('td');
                    actionCell.className = 'text-right';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-sm btn-danger';
                    deleteBtn.textContent = '√ó';
                    deleteBtn.onclick = () => {
                        if (confirm('Delete this transaction?')) {
                            Store.deleteTransaction(t.id);
                        }
                    };
                    actionCell.appendChild(deleteBtn);
                    
                    row.appendChild(dateCell);
                    row.appendChild(descCell);
                    row.appendChild(catCell);
                    row.appendChild(groupCell);
                    row.appendChild(amountCell);
                    row.appendChild(actionCell);
                    tbody.appendChild(row);
                });
            },

            renderPlanning() {
                document.getElementById('monthlyIncome').value = Store.state.income;
                
                const container = document.getElementById('categoryInputs');
                container.innerHTML = '';
                let totalBudgeted = 0;

                const order = { 'needs': 1, 'wants': 2, 'savings': 3 };
                const sortedCats = [...Store.state.categories].sort((a,b) => order[a.group] - order[b.group]);

                sortedCats.forEach(cat => {
                    totalBudgeted += cat.limit;
                    const div = document.createElement('div');
                    div.className = 'flex flex-between items-center mb-2';
                    div.style.padding = '0.5rem';
                    div.style.borderBottom = '1px solid var(--border)';
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.className = 'flex gap-2 items-center';
                    
                    const badge = document.createElement('span');
                    badge.className = `badge badge-${cat.group}`;
                    badge.textContent = cat.group;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = cat.name;
                    
                    leftDiv.appendChild(badge);
                    leftDiv.appendChild(nameSpan);
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = cat.limit;
                    input.min = '0';
                    input.step = '0.01';
                    input.style.width = '120px';
                    input.style.textAlign = 'right';
                    input.onchange = function() {
                        Store.updateBudgetLimit(cat.id, this.value);
                    };
                    
                    div.appendChild(leftDiv);
                    div.appendChild(input);
                    container.appendChild(div);
                });

                const remaining = Utils.roundMoney(Store.state.income - totalBudgeted);
                const unEl = document.getElementById('unassignedMoney');
                unEl.textContent = Utils.fmtMoney(remaining);
                unEl.className = remaining < 0 ? 'text-danger private-data' : 'text-success private-data';
            },

            renderInsights() {
                const { currentTx } = this.getMetrics();
                
                // Group Breakdown
                const groupData = { needs: 0, wants: 0, savings: 0 };
                currentTx.filter(t => t.type === 'expense').forEach(t => {
                    const cat = Utils.getCategoryById(t.category);
                    if (cat) groupData[cat.group] += Math.abs(t.amount);
                });

                const container = document.getElementById('groupBreakdown');
                container.innerHTML = '';
                const total = Utils.roundMoney(groupData.needs + groupData.wants + groupData.savings);
                
                Object.entries(groupData).forEach(([key, val]) => {
                    if (val === 0) return;
                    const pct = total > 0 ? ((val / total) * 100).toFixed(0) : 0;
                    
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'flex flex-between text-sm';
                    
                    const keySpan = document.createElement('span');
                    keySpan.style.textTransform = 'capitalize';
                    keySpan.textContent = key;
                    
                    const valSpan = document.createElement('span');
                    valSpan.className = 'private-data';
                    valSpan.textContent = `${pct}% (${Utils.fmtMoney(val)})`;
                    
                    labelDiv.appendChild(keySpan);
                    labelDiv.appendChild(valSpan);
                    
                    const progressTrack = document.createElement('div');
                    progressTrack.className = 'progress-track';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = 'progress-fill bg-primary';
                    progressFill.style.width = `${pct}%`;
                    
                    progressTrack.appendChild(progressFill);
                    div.appendChild(labelDiv);
                    div.appendChild(progressTrack);
                    container.appendChild(div);
                });

                // Trend Chart
                const chart = document.getElementById('trendChart');
                chart.innerHTML = '';
                const now = new Date();
                const months = [];
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push(d);
                }

                let maxSpent = 0;
                const monthlyTotals = months.map(m => {
                    const spent = Utils.roundMoney(
                        Math.abs(Store.state.transactions
                            .filter(t => t.type === 'expense' && 
                                   new Date(t.date).getMonth() === m.getMonth() && 
                                   new Date(t.date).getFullYear() === m.getFullYear())
                            .reduce((sum, t) => sum + t.amount, 0))
                    );
                    if (spent > maxSpent) maxSpent = spent;
                    return { label: m.toLocaleString('default', { month: 'short' }), val: spent };
                });

                monthlyTotals.forEach(d => {
                    const heightPct = maxSpent > 0 ? (d.val / maxSpent) * 100 : 0;
                    const col = document.createElement('div');
                    col.className = 'chart-col private-data';
                    col.style.height = `${Math.max(heightPct, 1)}%`;
                    col.title = Utils.fmtMoney(d.val);
                    
                    const label = document.createElement('span');
                    label.className = 'chart-label';
                    label.textContent = d.label;
                    
                    col.appendChild(label);
                    chart.appendChild(col);
                });
            },

            updateCategoryDropdowns() {
                const selects = [document.getElementById('filterCategory'), document.getElementById('txCategory')];
                const cats = Store.state.categories;
                
                selects.forEach(sel => {
                    if (!sel) return;
                    const currentVal = sel.value;
                    const startIdx = sel.id === 'filterCategory' ? 1 : 0;
                    while (sel.options.length > startIdx) sel.remove(startIdx);
                    
                    cats.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        sel.appendChild(opt);
                    });
                    if (currentVal && Array.from(sel.options).some(o => o.value === currentVal)) {
                        sel.value = currentVal;
                    }
                });
            },

            exportCSV() {
                const headers = ["Date", "Description", "Category", "Group", "Type", "Amount (PHP)"];
                const rows = Store.state.transactions.map(t => {
                    const cat = Utils.getCategoryById(t.category);
                    return [
                        t.date,
                        `"${t.desc.replace(/"/g, '""')}"`,
                        cat ? cat.name : "Uncategorized",
                        cat ? cat.group : "-",
                        t.type,
                        (t.type === 'expense' ? t.amount : t.amount).toFixed(2)
                    ].join(",");
                });
                
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "zenbudget_export_php.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        App.init();

    </script>
</body>
</html>
