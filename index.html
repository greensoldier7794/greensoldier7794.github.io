<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenBudget Pro - Complete Finance Manager (Fixed)</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0891b2;
            
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            
            --radius: 8px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --blur-amount: 0px;
        }

        body.dark-mode {
            --primary: #3b82f6;
            --primary-dark: #60a5fa;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-input: #374151;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body.privacy-mode { --blur-amount: 6px; }
        .private-data { filter: blur(var(--blur-amount)); transition: filter 0.3s; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); line-height: 1.5; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }

        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card { background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); transition: background-color 0.3s; }
        .flex { display: flex; align-items: center; }
        .flex-between { justify-content: space-between; }
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .hidden { display: none !important; }

        h1, h2, h3, h4 { font-weight: 600; color: var(--text-main); }
        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.1rem; }
        h4 { font-size: 1rem; }
        .text-sm { font-size: 0.875rem; color: var(--text-muted); }
        .text-xs { font-size: 0.75rem; color: var(--text-muted); }
        .text-xl { font-size: 1.5rem; font-weight: 700; }
        .text-2xl { font-size: 1.875rem; font-weight: 700; }
        .text-3xl { font-size: 2.25rem; font-weight: 700; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-info { color: var(--info); }

        button, .btn {
            cursor: pointer; padding: 0.5rem 1rem; border-radius: var(--radius); border: none; font-weight: 500; transition: all 0.2s; font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--bg-body); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        input, select, textarea {
            width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; 
            background: var(--bg-input); color: var(--text-main); transition: background 0.3s, color 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        .date-filter-bar { 
            background: var(--bg-card); padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem; border: 1px solid var(--border);
        }
        .preset-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .preset-buttons button { font-size: 0.85rem; padding: 0.4rem 0.8rem; }
        .preset-buttons button.active { background: var(--primary); color: white; }

        header { background: var(--bg-card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; transition: background-color 0.3s; }
        nav { display: flex; gap: 1rem; overflow-x: auto; padding-top: 1rem; }
        .nav-item {
            padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-muted); white-space: nowrap;
        }
        .nav-item.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
        .nav-item:hover { color: var(--text-main); }

        .progress-track { background: var(--bg-body); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }
        .bg-green { background: var(--success); }
        .bg-yellow { background: var(--warning); }
        .bg-red { background: var(--danger); }
        .bg-primary { background: var(--primary); }
        .bg-info { background: var(--info); }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-body); font-weight: 600; font-size: 0.85rem; color: var(--text-muted); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: var(--bg-body); }

        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 90;
        }

        dialog {
            border: none; border-radius: var(--radius); padding: 0; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 600px; width: 90%; margin: auto; background: var(--bg-card); color: var(--text-main);
        }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 1rem 1.5rem; background: var(--bg-body); display: flex; justify-content: flex-end; gap: 0.5rem; }

        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-needs { background: #dbeafe; color: #1e40af; }
        .badge-wants { background: #fce7f3; color: #9d174d; }
        .badge-savings { background: #d1fae5; color: #065f46; }
        
        body.dark-mode .badge-needs { background: #1e3a8a; color: #dbeafe; }
        body.dark-mode .badge-wants { background: #831843; color: #fce7f3; }
        body.dark-mode .badge-savings { background: #064e3b; color: #d1fae5; }
        
        .badge-checking { background: #dbeafe; color: #1e40af; }
        .badge-cash { background: #fef3c7; color: #92400e; }
        .badge-credit { background: #fee2e2; color: #991b1b; }
        .badge-investment { background: #e0e7ff; color: #3730a3; }
        .badge-ewallet { background: #ddd6fe; color: #5b21b6; }
        
        body.dark-mode .badge-checking { background: #1e3a8a; color: #dbeafe; }
        body.dark-mode .badge-cash { background: #78350f; color: #fef3c7; }
        body.dark-mode .badge-credit { background: #7f1d1d; color: #fee2e2; }
        body.dark-mode .badge-investment { background: #312e81; color: #e0e7ff; }
        body.dark-mode .badge-ewallet { background: #4c1d95; color: #ddd6fe; }
        
        .box-highlight { background: #eef2ff; border-radius: 8px; padding: 1rem; }
        body.dark-mode .box-highlight { background: #374151; }

        .chart-bar-container { display: flex; align-items: flex-end; height: 150px; gap: 4px; padding-top: 20px;}
        .chart-col { flex: 1; background: var(--primary); border-radius: 4px 4px 0 0; position: relative; min-height: 2px; transition: height 0.3s; opacity: 0.8;}
        .chart-col:hover { opacity: 1; }
        .chart-label { position: absolute; bottom: -25px; left: 0; right: 0; text-align: center; font-size: 10px; color: var(--text-muted); white-space: nowrap; }
        
        .color-picker { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-option.selected { border-color: var(--text-main); box-shadow: 0 0 0 2px var(--bg-card); }
        
        .recurring-badge { background: var(--warning); color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; }
        .transfer-badge { background: var(--info); color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; }
        .reconciled-badge { background: var(--success); color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; }
        
        .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .comparison-card { border: 2px solid var(--border); }
        
        .calendar-grid { display: grid; gap: 0.5rem; }
        .month-item { padding: 1rem; background: var(--bg-body); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; }
        .month-item:hover { background: var(--border); }
        .month-item.current { border: 2px solid var(--primary); }
        
        .alert { padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem; border-left: 4px solid; }
        .alert-warning { background: #fef3c7; border-color: var(--warning); color: #92400e; }
        .alert-danger { background: #fee2e2; border-color: var(--danger); color: #991b1b; }
        .alert-success { background: #d1fae5; border-color: var(--success); color: #065f46; }
        .alert-info { background: #dbeafe; border-color: var(--info); color: #1e40af; }
        body.dark-mode .alert-warning { background: #78350f; color: #fef3c7; }
        body.dark-mode .alert-danger { background: #7f1d1d; color: #fee2e2; }
        body.dark-mode .alert-success { background: #064e3b; color: #d1fae5; }
        body.dark-mode .alert-info { background: #1e3a8a; color: #dbeafe; }
        
        .error-container { padding: 2rem; text-align: center; }
        .error-icon { font-size: 3rem; margin-bottom: 1rem; }
        
        .account-card {
            background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius); padding: 1.25rem;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .account-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .account-card.low-balance { border-color: var(--danger); }
        .account-icon {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <div class="flex flex-between">
                <div class="flex gap-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <h1>ZenBudget Pro</h1>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-outline btn-sm" id="toggleTheme">üåô</button>
                    <button class="btn btn-outline btn-sm" id="togglePrivacy">üëÅÔ∏è</button>
                    <button class="btn btn-outline btn-sm" id="exportBtn">‚¨á Export</button>
                    <button class="btn btn-outline btn-sm" id="backupBtn">üíæ Backup</button>
                </div>
            </div>
            <nav>
                <div class="nav-item active" data-tab="dashboard">Dashboard</div>
                <div class="nav-item" data-tab="accounts">Accounts</div>
                <div class="nav-item" data-tab="transactions">Transactions</div>
                <div class="nav-item" data-tab="planning">Planning</div>
                <div class="nav-item" data-tab="insights">Insights</div>
                <div class="nav-item" data-tab="recurring">Recurring</div>
                <div class="nav-item" data-tab="compare">Compare</div>
            </nav>
        </div>
    </header>

    <main class="container mt-4">
        
        <!-- Date Filter Bar -->
        <div class="date-filter-bar">
            <div class="flex flex-between flex-wrap gap-2">
                <div class="flex gap-2 flex-wrap">
                    <div><label class="text-sm">From:</label><input type="date" id="dateFrom" style="width: 150px;"></div>
                    <div><label class="text-sm">To:</label><input type="date" id="dateTo" style="width: 150px;"></div>
                    <button class="btn btn-primary btn-sm" id="applyDateFilter">Apply</button>
                    <button class="btn btn-outline btn-sm" id="clearDateFilter">Clear</button>
                </div>
                <div class="preset-buttons">
                    <button class="btn-sm btn-outline" data-preset="thisWeek">This Week</button>
                    <button class="btn-sm btn-outline active" data-preset="thisMonth">This Month</button>
                    <button class="btn-sm btn-outline" data-preset="lastMonth">Last Month</button>
                    <button class="btn-sm btn-outline" data-preset="last3Months">Last 3 Months</button>
                    <button class="btn-sm btn-outline" data-preset="thisYear">This Year</button>
                    <button class="btn-sm btn-outline" data-preset="all">All Time</button>
                </div>
            </div>
        </div>
        
        <!-- DASHBOARD -->
        <section id="dashboard" class="view">
            <div id="budgetAlerts"></div>
            
            <div class="card mb-4" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none;">
                <div class="flex flex-between flex-wrap gap-4">
                    <div>
                        <div class="text-sm" style="opacity: 0.9;">Total Net Worth</div>
                        <div class="text-3xl private-data" id="dashNetWorth">‚Ç±0.00</div>
                        <div class="text-xs mt-2" style="opacity: 0.8;">Across all accounts</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm" style="opacity: 0.9;">Liquid Assets</div>
                        <div class="text-xl private-data" id="dashLiquid">‚Ç±0.00</div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-4 mb-4">
                <div class="card"><div class="text-sm">Total Income</div><div class="text-xl text-success private-data" id="dashTotalIncome">‚Ç±0.00</div></div>
                <div class="card"><div class="text-sm">Total Spent</div><div class="text-xl text-danger private-data" id="dashTotalSpent">‚Ç±0.00</div></div>
                <div class="card"><div class="text-sm">Net Balance</div><div class="text-xl private-data" id="dashNet">‚Ç±0.00</div></div>
                <div class="card"><div class="text-sm">Savings Rate</div><div class="text-xl private-data" id="dashSavingsRate">0%</div></div>
            </div>

            <div class="grid grid-2">
                <div class="card"><h3>Budget Status</h3><div id="budgetBars" class="mt-4 grid gap-4"></div></div>
                <div class="card"><h3>Recent Transactions</h3><div id="recentList" class="mt-4 grid gap-2"></div></div>
            </div>
            
            <div class="grid grid-2 mt-4">
                <div class="card"><h3>Account Overview</h3><div id="accountSummary" class="mt-4"></div></div>
                <div class="card"><h3>Monthly Overview</h3><div id="monthlyCalendar" class="calendar-grid mt-4"></div></div>
            </div>
        </section>

        <!-- ACCOUNTS TAB -->
        <section id="accounts" class="view hidden">
            <div class="flex flex-between mb-4">
                <div><h2>Bank Accounts & Funds</h2><p class="text-sm">Manage all your financial accounts</p></div>
                <button class="btn btn-primary" id="addAccountBtn">+ Add Account</button>
            </div>
            
            <div id="accountAlerts"></div>
            
            <div class="grid grid-3 mb-4">
                <div class="card"><div class="text-sm">Total Assets</div><div class="text-xl text-success private-data" id="totalAssets">‚Ç±0.00</div></div>
                <div class="card"><div class="text-sm">Total Liabilities</div><div class="text-xl text-danger private-data" id="totalLiabilities">‚Ç±0.00</div></div>
                <div class="card"><div class="text-sm">Net Worth</div><div class="text-xl private-data" id="netWorthDisplay">‚Ç±0.00</div></div>
            </div>
            
            <div class="grid grid-2">
                <div><h3 class="mb-4">Your Accounts</h3><div id="accountsList" class="grid gap-3"></div></div>
                <div><h3 class="mb-4">Account Balance Distribution</h3><div id="accountDistribution"></div></div>
            </div>
        </section>

        <!-- TRANSACTIONS TAB -->
        <section id="transactions" class="view hidden">
            <div class="card">
                <div class="flex flex-between mb-4 flex-wrap gap-2">
                    <input type="text" id="searchTx" placeholder="Search..." style="max-width: 250px;">
                    <select id="filterAccount" style="max-width: 180px;"><option value="all">All Accounts</option></select>
                    <select id="filterCategory" style="max-width: 180px;"><option value="all">All Categories</option></select>
                    <select id="filterType" style="max-width: 150px;">
                        <option value="all">All Types</option>
                        <option value="expense">Expenses</option>
                        <option value="income">Income</option>
                        <option value="transfer_out">Transfers Out</option>
                        <option value="transfer_in">Transfers In</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Description</th><th>Account</th><th>Category</th><th class="text-right">Amount</th><th class="text-center">Status</th><th class="text-right">Actions</th></tr>
                        </thead>
                        <tbody id="txTableBody"></tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-right" id="transactionSummary"></div>
            </div>
        </section>

        <!-- PLANNING TAB -->
        <section id="planning" class="view hidden">
            <div class="grid grid-2">
                <div class="card">
                    <h3>Budget Configuration</h3>
                    <div class="flex flex-between mb-4"><span>Expected Monthly Income:</span><input type="number" id="monthlyIncome" value="0" style="width: 150px;"></div>
                    <div id="categoryInputs"></div>
                    <div class="mt-4 box-highlight"><div class="flex flex-between"><strong>Unassigned:</strong><strong id="unassignedMoney" class="private-data">‚Ç±0.00</strong></div></div>
                </div>
                <div class="card">
                    <h3>Manage Categories</h3>
                    <form id="addCategoryForm" class="flex flex-col gap-4 mb-4">
                        <input type="text" id="newCatName" placeholder="Category Name" required maxlength="50">
                        <select id="newCatGroup">
                            <option value="needs">Needs</option>
                            <option value="wants">Wants</option>
                            <option value="savings">Savings</option>
                        </select>
                        <div><label class="text-sm">Color:</label><div class="color-picker" id="newCatColorPicker"></div><input type="hidden" id="newCatColor" value="#2563eb"></div>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </form>
                    <h4 class="mb-2">Existing Categories</h4>
                    <div id="categoryList" class="grid gap-2"></div>
                </div>
            </div>
        </section>

        <!-- INSIGHTS TAB -->
        <section id="insights" class="view hidden">
            <div class="grid grid-2">
                <div class="card"><h3>Spending by Group</h3><div id="groupBreakdown" class="mt-4"></div></div>
                <div class="card"><h3>Last 12 Months</h3><div id="trendChart" class="chart-bar-container"></div></div>
            </div>
            <div class="grid grid-2 mt-4">
                <div class="card"><h3>Category Breakdown</h3><div id="categoryBreakdown" class="mt-4"></div></div>
                <div class="card"><h3>Weekly (Last 8 Weeks)</h3><div id="weeklyChart" class="chart-bar-container"></div></div>
            </div>
            <div class="card mt-4"><h3>Account Balance History</h3><div id="balanceHistoryChart" class="chart-bar-container"></div></div>
        </section>
        
        <!-- RECURRING TAB -->
        <section id="recurring" class="view hidden">
            <div class="card">
                <div class="flex flex-between mb-4">
                    <div><h3>Recurring Transactions</h3></div>
                    <button class="btn btn-primary" id="addRecurringBtn">+ Add Recurring</button>
                </div>
                <div id="recurringList" class="grid gap-2"></div>
            </div>
        </section>
        
        <!-- COMPARE TAB -->
        <section id="compare" class="view hidden">
            <div class="card mb-4">
                <h3>Period Comparison</h3>
                <div class="grid grid-2 gap-4 mt-4">
                    <div><label class="text-sm">Period 1:</label><div class="flex gap-2"><input type="date" id="compare1From"><input type="date" id="compare1To"></div></div>
                    <div><label class="text-sm">Period 2:</label><div class="flex gap-2"><input type="date" id="compare2From"><input type="date" id="compare2To"></div></div>
                </div>
                <button class="btn btn-primary mt-4" id="runComparisonBtn">Run Comparison</button>
            </div>
            <div id="comparisonResults"></div>
        </section>
    </main>

    <button class="fab" id="openAddTxModal">+</button>

    <!-- Transaction Modal -->
    <dialog id="txModal">
        <form id="txForm">
            <div class="modal-header"><h3>Add Transaction</h3><button type="button" class="btn-outline" style="border:none;" onclick="document.getElementById('txModal').close()">‚úï</button></div>
            <div class="modal-body grid gap-4">
                <div class="flex gap-2">
                    <button type="button" class="btn btn-primary flex-1" id="typeExpense">Expense</button>
                    <button type="button" class="btn btn-outline flex-1" id="typeIncome">Income</button>
                    <button type="button" class="btn btn-outline flex-1" id="typeTransfer">Transfer</button>
                </div>
                <input type="hidden" id="txType" value="expense">
                <div><label class="text-sm">Amount</label><input type="number" id="txAmount" step="0.01" required min="0.01"></div>
                <div><label class="text-sm">Date</label><input type="date" id="txDate" required></div>
                <div><label class="text-sm">Description</label><input type="text" id="txDesc" required maxlength="200"></div>
                <div id="accountSelectContainer"><label class="text-sm">Account</label><select id="txAccount" required></select></div>
                <div id="transferToContainer" class="hidden"><label class="text-sm">Transfer To</label><select id="txTransferTo"></select></div>
                <div id="categorySelectContainer"><label class="text-sm">Category</label><select id="txCategory" required></select></div>
                <div><label class="text-sm"><input type="checkbox" id="txReconciled"> Mark as cleared</label></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-outline" onclick="document.getElementById('txModal').close()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </dialog>
    
    <!-- Account Modal -->
    <dialog id="accountModal">
        <form id="accountForm">
            <div class="modal-header"><h3 id="accountModalTitle">Add Account</h3><button type="button" class="btn-outline" style="border:none;" onclick="document.getElementById('accountModal').close()">‚úï</button></div>
            <div class="modal-body grid gap-4">
                <input type="hidden" id="accountId">
                <div><label class="text-sm">Account Name *</label><input type="text" id="accountName" required maxlength="100"></div>
                <div><label class="text-sm">Type *</label>
                    <select id="accountType" required>
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="cash">Cash/Wallet</option>
                        <option value="credit">Credit Card</option>
                        <option value="investment">Investment</option>
                        <option value="ewallet">E-Wallet</option>
                    </select>
                </div>
                <div><label class="text-sm">Bank/Institution</label><input type="text" id="accountInstitution" maxlength="100"></div>
                <div><label class="text-sm">Current Balance *</label><input type="number" id="accountBalance" step="0.01" required></div>
                <div><label class="text-sm">Target/Goal Balance</label><input type="number" id="accountGoal" step="0.01"></div>
                <div><label class="text-sm">Low Balance Alert</label><input type="number" id="accountThreshold" step="0.01"></div>
                <div><label class="text-sm">Color:</label><div class="color-picker" id="accountColorPicker"></div><input type="hidden" id="accountColor" value="#2563eb"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-outline" onclick="document.getElementById('accountModal').close()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </dialog>
    
    <!-- Recurring Modal -->
    <dialog id="recurringModal">
        <form id="recurringForm">
            <div class="modal-header"><h3 id="recurringModalTitle">Add Recurring</h3><button type="button" class="btn-outline" style="border:none;" onclick="document.getElementById('recurringModal').close()">‚úï</button></div>
            <div class="modal-body grid gap-4">
                <input type="hidden" id="recurringId">
                <div><label class="text-sm">Description</label><input type="text" id="recurringDesc" required maxlength="200"></div>
                <div><label class="text-sm">Amount</label><input type="number" id="recurringAmount" step="0.01" required min="0.01"></div>
                <div><label class="text-sm">Account</label><select id="recurringAccount" required></select></div>
                <div><label class="text-sm">Category</label><select id="recurringCategory" required></select></div>
                <div><label class="text-sm">Frequency</label>
                    <select id="recurringFrequency">
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div><label class="text-sm">Day of Month (1-28)</label><input type="number" id="recurringDay" min="1" max="28" value="1"></div>
                <div><label class="text-sm">Start Date</label><input type="date" id="recurringStartDate" required></div>
                <div><label class="text-sm"><input type="checkbox" id="recurringActive" checked> Active</label></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-outline" onclick="document.getElementById('recurringModal').close()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </dialog>
    
    <!-- Export Modal -->
    <dialog id="exportModal">
        <div class="modal-header"><h3>Export Data</h3><button type="button" class="btn-outline" style="border:none;" onclick="document.getElementById('exportModal').close()">‚úï</button></div>
        <div class="modal-body">
            <div class="flex flex-col gap-4">
                <button class="btn btn-primary" id="exportCurrentCSV">Export Current View</button>
                <button class="btn btn-primary" id="exportAllCSV">Export All Data</button>
                <button class="btn btn-primary" id="exportAccountsCSV">Export Accounts</button>
                <button class="btn btn-primary" id="exportMonthlyReport">Export Monthly Report</button>
            </div>
        </div>
    </dialog>
    
    <!-- Backup Modal -->
    <dialog id="backupModal">
        <div class="modal-header"><h3>Backup & Restore</h3><button type="button" class="btn-outline" style="border:none;" onclick="document.getElementById('backupModal').close()">‚úï</button></div>
        <div class="modal-body">
            <div class="flex flex-col gap-4">
                <button class="btn btn-success" id="exportBackupBtn">üì• Download Full Backup</button>
                <div class="mt-2">
                    <label class="btn btn-info" for="importBackupFile">üì§ Restore from Backup</label>
                    <input type="file" id="importBackupFile" accept=".json" style="display:none;">
                    <p class="text-xs mt-2">‚ö†Ô∏è Warning: This will replace all current data!</p>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        /**
         * ZenBudget Pro - FULLY CORRECTED VERSION
         * 
         * ‚úÖ FIXED: All critical bugs
         * ‚úÖ FIXED: All high priority issues  
         * ‚úÖ ADDED: All recommended improvements
         * 
         * Changes:
         * - Fixed double account balance deduction bug
         * - Fixed ID collision with better unique ID generation
         * - Fixed transfer transactions to create proper two-way entries
         * - Added proper transfer deletion handling
         * - Added floating-point rounding everywhere
         * - Fixed race condition in initialization
         * - Added comprehensive input validation
         * - Fixed memory leak with event listener cleanup
         * - Optimized rendering (selective updates)
         * - Reduced code duplication in exports
         * - Optimized transaction filtering
         * - Added data versioning and migration
         * - Added backup/restore functionality
         */

        const COLOR_PALETTE = ['#2563eb', '#dc2626', '#059669', '#d97706', '#7c3aed', '#db2777', '#0891b2', '#65a30d', '#ea580c', '#4f46e5'];
        const ACCOUNT_ICONS = {'checking': 'üè¶', 'savings': 'üí∞', 'cash': 'üíµ', 'credit': 'üí≥', 'investment': 'üìà', 'ewallet': 'üì±'};
        
        // ‚úÖ FIX: Better unique ID generation to prevent collisions
        let uniqueIdCounter = 0;
        const DATA_VERSION = 4; // ‚úÖ NEW: Version tracking

        // ‚úÖ PASTE PART 2 CODE BELOW THIS LINE

/* --- VALIDATORS --- */
        const Validators = {
            isValidAmount: (amount) => typeof amount === 'number' && !isNaN(amount) && isFinite(amount) && amount !== 0 && Math.abs(amount) < 999999999,
            isValidDate: (dateStr) => {
                if (!dateStr) return false;
                const date = new Date(dateStr);
                return !isNaN(date.getTime()) && date.getFullYear() >= 2000 && date.getFullYear() <= 2100;
            },
            isValidCategory: (categoryId) => categoryId && Store.state.categories.some(c => c.id === categoryId),
            isValidAccount: (accountId) => accountId && Store.state.accounts.some(a => a.id === accountId),
            isValidHexColor: (color) => /^#[0-9A-F]{6}$/i.test(color),
            sanitizeString: (str, maxLength = 200) => typeof str === 'string' ? str.trim().substring(0, maxLength) : ''
        };

        /* --- STORE --- */
        const Store = {
            state: {
                _version: DATA_VERSION,
                transactions: [],
                accounts: [],
                categories: [
                    {id:'c1',name:'Rent/Mortgage',group:'needs',limit:15000,color:'#2563eb'},
                    {id:'c2',name:'Groceries',group:'needs',limit:5000,color:'#059669'},
                    {id:'c3',name:'Utilities',group:'needs',limit:2000,color:'#d97706'},
                    {id:'c4',name:'Dining Out',group:'wants',limit:1500,color:'#dc2626'},
                    {id:'c5',name:'Entertainment',group:'wants',limit:1000,color:'#7c3aed'},
                    {id:'c6',name:'Emergency Fund',group:'savings',limit:3000,color:'#0891b2'}
                ],
                recurringTransactions: [],
                income: 30000,
                privacyMode: false,
                theme: 'light',
                dateFilter: {from: null, to: null, preset: 'thisMonth'}
            },

            // ‚úÖ FIX: Better unique ID generation
            generateUniqueId(prefix = 'tx') {
                uniqueIdCounter++;
                return `${prefix}_${Date.now()}_${uniqueIdCounter}_${Math.random().toString(36).substr(2, 6)}`;
            },

            // ‚úÖ NEW: Data migration
            migrateData(data, fromVersion) {
                if (fromVersion < 2) {
                    data.accounts = data.accounts || [];
                }
                if (fromVersion < 3) {
                    if (data.transactions) {
                        data.transactions.forEach(t => {
                            if (t.reconciled === undefined) t.reconciled = false;
                        });
                    }
                }
                if (fromVersion < 4) {
                    // Fix any old transfer format to new format
                    if (data.transactions) {
                        data.transactions.forEach(t => {
                            if (t.type === 'transfer' && !t.linkedTransferId) {
                                t.type = 'transfer_out';
                            }
                        });
                    }
                }
                return data;
            },

            init() {
                try {
                    const saved = localStorage.getItem('zenbudget_pro_data_v3');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        
                        // ‚úÖ NEW: Check version and migrate
                        const dataVersion = parsed._version || 1;
                        if (dataVersion < DATA_VERSION) {
                            this.migrateData(parsed, dataVersion);
                        }
                        
                        parsed._version = DATA_VERSION;
                        this.state = {...this.state, ...parsed};
                        
                        if (!this.state.accounts) this.state.accounts = [];
                        this.state.categories = this.state.categories.map(cat => ({...cat, color: cat.color || COLOR_PALETTE[0]}));
                        this.state.accounts = this.state.accounts.map(acc => ({
                            ...acc,
                            color: acc.color || COLOR_PALETTE[0],
                            balance: parseFloat(acc.balance) || 0,
                            goalBalance: parseFloat(acc.goalBalance) || null,
                            lowBalanceThreshold: parseFloat(acc.lowBalanceThreshold) || null
                        }));
                        if (!this.state.recurringTransactions) this.state.recurringTransactions = [];
                    }
                } catch (error) {
                    console.error('Failed to load:', error);
                    alert('Failed to load data. Starting fresh.');
                    return;
                }
                
                // ‚úÖ FIX: Don't process recurring here - will be done after render
            },

            save(skipRender = false, sectionsToRender = ['all']) {
                try {
                    localStorage.setItem('zenbudget_pro_data_v3', JSON.stringify(this.state));
                } catch (error) {
                    console.error('Save error:', error);
                    if (error.name === 'QuotaExceededError') {
                        alert('Storage full! Please export and clear old data.');
                    }
                    return false;
                }
                if (!skipRender) App.render(sectionsToRender);
                return true;
            },

            addTransaction(tx) {
                if (!tx.amount || !tx.date || !tx.desc || !tx.type) return false;
                const amount = parseFloat(tx.amount);
                if (!Validators.isValidAmount(amount)) {alert('Invalid amount'); return false;}
                if (!Validators.isValidDate(tx.date)) {alert('Invalid date'); return false;}
                if (tx.type !== 'transfer_out' && tx.accountId && !Validators.isValidAccount(tx.accountId)) {alert('Invalid account'); return false;}
                if (tx.type === 'expense' && tx.category && !Validators.isValidCategory(tx.category)) {alert('Invalid category'); return false;}
                
                const desc = Validators.sanitizeString(tx.desc, 200);
                if (!desc) {alert('Description required'); return false;}
                
                let finalAmount = amount;
                if (tx.type === 'expense') finalAmount = -Math.abs(amount);
                else if (tx.type === 'income') finalAmount = Math.abs(amount);
                else if (tx.type === 'transfer_out') finalAmount = -Math.abs(amount);
                else if (tx.type === 'transfer_in') finalAmount = Math.abs(amount);
                
                const newTx = {
                    ...tx, desc,
                    id: this.generateUniqueId('tx'),
                    amount: Utils.roundMoney(finalAmount),
                    recurring: tx.recurring || false,
                    recurringId: tx.recurringId || null,
                    reconciled: tx.reconciled || false,
                    linkedTransferId: tx.linkedTransferId || null,
                    createdAt: new Date().toISOString()
                };
                
                this.state.transactions.push(newTx);
                
                // ‚úÖ FIX: Handle transfers properly with two transactions
                if (tx.type === 'transfer_out') {
                    if (!tx.transferTo) {alert('Transfer destination required'); return false;}
                    if (!Validators.isValidAccount(tx.transferTo)) {alert('Invalid destination account'); return false;}
                    
                    const transferIn = {
                        date: tx.date,
                        desc: `Transfer from ${Utils.getAccountName(tx.accountId)}`,
                        accountId: tx.transferTo,
                        amount: amount,
                        type: 'transfer_in',
                        recurring: false,
                        reconciled: tx.reconciled || false,
                        linkedTransferId: newTx.id,
                        id: this.generateUniqueId('tx'),
                        createdAt: new Date().toISOString()
                    };
                    
                    newTx.linkedTransferId = transferIn.id;
                    this.state.transactions.push(transferIn);
                    
                    this.updateAccountBalance(tx.accountId, -Math.abs(amount));
                    this.updateAccountBalance(tx.transferTo, Math.abs(amount));
                } else if (tx.accountId) {
                    this.updateAccountBalance(tx.accountId, finalAmount);
                }
                
                this.save(false, ['dashboard', 'transactions']);
                return true;
            },

            // ‚úÖ NEW: Silent version for recurring transactions
            addTransactionSilent(tx) {
                if (!tx.amount || !tx.date || !tx.desc || !tx.type) return false;
                const amount = parseFloat(tx.amount);
                if (!Validators.isValidAmount(amount)) return false;
                if (!Validators.isValidDate(tx.date)) return false;
                if (tx.accountId && !Validators.isValidAccount(tx.accountId)) return false;
                if (tx.type === 'expense' && tx.category && !Validators.isValidCategory(tx.category)) return false;
                
                const desc = Validators.sanitizeString(tx.desc, 200);
                if (!desc) return false;
                
                let finalAmount = tx.type === 'expense' ? -Math.abs(amount) : Math.abs(amount);
                
                const newTx = {
                    ...tx, desc,
                    id: this.generateUniqueId('tx'),
                    amount: Utils.roundMoney(finalAmount),
                    recurring: tx.recurring || false,
                    recurringId: tx.recurringId || null,
                    reconciled: tx.reconciled || false,
                    createdAt: new Date().toISOString()
                };
                
                this.state.transactions.push(newTx);
                if (tx.accountId) this.updateAccountBalance(tx.accountId, finalAmount);
                
                return true;
            },

            // ‚úÖ FIX: Proper transfer deletion
            deleteTransaction(id) {
                const tx = this.state.transactions.find(t => t.id === id);
                if (!tx) return false;
                
                // Handle linked transfers
                if ((tx.type === 'transfer_out' || tx.type === 'transfer_in') && tx.linkedTransferId) {
                    const linkedTx = this.state.transactions.find(t => t.id === tx.linkedTransferId);
                    if (linkedTx && linkedTx.accountId) {
                        this.updateAccountBalance(linkedTx.accountId, -linkedTx.amount);
                    }
                    this.state.transactions = this.state.transactions.filter(t => t.id !== linkedTx.id);
                }
                
                if (tx.accountId) this.updateAccountBalance(tx.accountId, -tx.amount);
                this.state.transactions = this.state.transactions.filter(t => t.id !== id);
                this.save(false, ['dashboard', 'transactions']);
                return true;
            },
            
            toggleReconciled(id) {
                const tx = this.state.transactions.find(t => t.id === id);
                if (tx && !tx.recurring) {
                    tx.reconciled = !tx.reconciled;
                    this.save(false, ['transactions']);
                    return true;
                }
                return false;
            },

            addAccount(account) {
                const name = Validators.sanitizeString(account.name, 100);
                if (!name) {alert('Account name required'); return false;}
                const balance = parseFloat(account.balance);
                if (isNaN(balance)) {alert('Invalid balance'); return false;}
                
                const newAccount = {
                    id: account.id || this.generateUniqueId('acc'),
                    name, type: account.type || 'checking',
                    institution: Validators.sanitizeString(account.institution, 100),
                    balance: Utils.roundMoney(balance),
                    goalBalance: account.goalBalance ? Utils.roundMoney(parseFloat(account.goalBalance)) : null,
                    lowBalanceThreshold: account.lowBalanceThreshold ? Utils.roundMoney(parseFloat(account.lowBalanceThreshold)) : null,
                    color: Validators.isValidHexColor(account.color) ? account.color : COLOR_PALETTE[0],
                    createdAt: account.createdAt || new Date().toISOString()
                };
                
                const idx = this.state.accounts.findIndex(a => a.id === newAccount.id);
                if (idx >= 0) this.state.accounts[idx] = newAccount;
                else this.state.accounts.push(newAccount);
                
                this.save(false, ['dashboard', 'accounts']);
                return true;
            },
            
            deleteAccount(id) {
                if (this.state.transactions.some(t => t.accountId === id || t.transferTo === id)) {
                    if (!confirm('This account has transactions. Delete anyway?')) return false;
                }
                this.state.accounts = this.state.accounts.filter(a => a.id !== id);
                this.save(false, ['dashboard', 'accounts']);
                return true;
            },
            
            updateAccountBalance(accountId, amount) {
                const account = this.state.accounts.find(a => a.id === accountId);
                if (account) {
                    account.balance = Utils.roundMoney(account.balance + amount);
                    return true;
                }
                return false;
            },

            addCategory(name, group, color) {
                const sanitizedName = Validators.sanitizeString(name, 50);
                if (!sanitizedName) {alert('Category name required'); return false;}
                if (!['needs', 'wants', 'savings'].includes(group)) {alert('Invalid group'); return false;}
                
                this.state.categories.push({ 
                    id: this.generateUniqueId('cat'),
                    name: sanitizedName, group, limit: 0,
                    color: Validators.isValidHexColor(color) ? color : COLOR_PALETTE[0]
                });
                this.save(false, ['planning', 'dashboard']);
                return true;
            },
            
            deleteCategory(id) {
                if (this.state.transactions.some(t => t.category === id)) {
                    if (!confirm('This category has transactions. Delete anyway?')) return false;
                }
                this.state.categories = this.state.categories.filter(c => c.id !== id);
                this.save(false, ['planning', 'dashboard']);
                return true;
            },
            
            updateCategory(id, updates) {
                const cat = this.state.categories.find(c => c.id === id);
                if (!cat) return false;
                if (updates.color && !Validators.isValidHexColor(updates.color)) {alert('Invalid color'); return false;}
                if (updates.name) {
                    updates.name = Validators.sanitizeString(updates.name, 50);
                    if (!updates.name) {alert('Name required'); return false;}
                }
                Object.assign(cat, updates);
                this.save(false, ['planning']);
                return true;
            },

            updateBudgetLimit(id, limit) {
                const cat = this.state.categories.find(c => c.id === id);
                if (!cat) return false;
                const parsed = parseFloat(limit);
                if (isNaN(parsed) || parsed < 0) {alert('Invalid limit'); return false;}
                cat.limit = Utils.roundMoney(parsed);
                this.save(false, ['planning', 'dashboard']);
                return true;
            },
            
            addRecurringTransaction(recurring) {
                if (!recurring.description || !recurring.amount || !recurring.category || !recurring.frequency || !recurring.startDate || !recurring.accountId) {
                    alert('All fields required');
                    return false;
                }
                
                const amount = parseFloat(recurring.amount);
                if (!Validators.isValidAmount(amount)) {alert('Invalid amount'); return false;}
                if (!Validators.isValidDate(recurring.startDate)) {alert('Invalid date'); return false;}
                if (!Validators.isValidCategory(recurring.category)) {alert('Invalid category'); return false;}
                if (!Validators.isValidAccount(recurring.accountId)) {alert('Invalid account'); return false;}
                
                const desc = Validators.sanitizeString(recurring.description, 200);
                if (!desc) {alert('Description required'); return false;}
                
                const valid = {
                    id: recurring.id || this.generateUniqueId('rec'),
                    description: desc, amount: Utils.roundMoney(amount),
                    category: recurring.category, accountId: recurring.accountId,
                    frequency: recurring.frequency, dayOfMonth: parseInt(recurring.dayOfMonth) || 1,
                    startDate: recurring.startDate, active: recurring.active !== false,
                    lastProcessed: recurring.lastProcessed || null
                };
                
                const idx = this.state.recurringTransactions.findIndex(r => r.id === valid.id);
                if (idx >= 0) this.state.recurringTransactions[idx] = valid;
                else this.state.recurringTransactions.push(valid);
                
                this.save(false, ['recurring']);
                return true;
            },
            
            deleteRecurringTransaction(id) {
                this.state.recurringTransactions = this.state.recurringTransactions.filter(r => r.id !== id);
                this.save(false, ['recurring']);
                return true;
            },
            
            calculateNextDueDate(recurring, lastProcessed, startDate, today) {
                let nextDate = lastProcessed ? new Date(lastProcessed) : new Date(startDate);
                nextDate.setHours(0, 0, 0, 0);
                
                if (!lastProcessed) {
                    if (recurring.frequency === 'monthly') {
                        const targetDay = Math.min(recurring.dayOfMonth || 1, 28);
                        nextDate.setDate(targetDay);
                        if (nextDate < startDate) {
                            nextDate.setMonth(nextDate.getMonth() + 1);
                            nextDate.setDate(targetDay);
                        }
                    }
                    return nextDate;
                }
                
                switch(recurring.frequency) {
                    case 'monthly':
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        nextDate.setDate(Math.min(recurring.dayOfMonth || 1, 28));
                        break;
                    case 'weekly': nextDate.setDate(nextDate.getDate() + 7); break;
                    case 'biweekly': nextDate.setDate(nextDate.getDate() + 14); break;
                    case 'yearly': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
                    default: return null;
                }
                return nextDate;
            },
            
            // ‚úÖ FIX: No double balance deduction
            processRecurringTransactions() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let hasChanges = false;
                
                this.state.recurringTransactions.forEach(recurring => {
                    if (!recurring.active) return;
                    const startDate = new Date(recurring.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    if (startDate > today) return;
                    
                    const lastProcessed = recurring.lastProcessed ? new Date(recurring.lastProcessed) : null;
                    let nextDueDate = this.calculateNextDueDate(recurring, lastProcessed, startDate, today);
                    
                    if (nextDueDate && nextDueDate <= today) {
                        const exists = this.state.transactions.some(t => t.recurringId === recurring.id && t.date === nextDueDate.toISOString().split('T')[0]);
                        
                        if (!exists) {
                            // ‚úÖ FIX: Use silent version to avoid double balance update
                            const success = this.addTransactionSilent({
                                date: nextDueDate.toISOString().split('T')[0],
                                desc: recurring.description,
                                category: recurring.category,
                                accountId: recurring.accountId,
                                amount: recurring.amount,
                                type: 'expense',
                                recurring: true,
                                recurringId: recurring.id,
                                reconciled: false
                            });
                            
                            if (success) {
                                recurring.lastProcessed = nextDueDate.toISOString().split('T')[0];
                                hasChanges = true;
                            }
                        }
                    }
                });
                
                if (hasChanges) {
                    this.save(false, ['dashboard', 'transactions']);
                }
            },
            
            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                this.save(true);
                return this.state.theme;
            },
            
            setDateFilter(from, to, preset) {
                this.state.dateFilter = {from, to, preset};
                this.save(true);
            }
        };

        /* --- UTILS --- */
        const Utils = {
            roundMoney: (num) => Math.round((num + Number.EPSILON) * 100) / 100,
            roundPercentage: (num) => Math.round((num + Number.EPSILON) * 10) / 10,
            fmtMoney: (num) => {
                if (typeof num !== 'number' || isNaN(num)) return '‚Ç±0.00';
                return new Intl.NumberFormat('en-PH', {style: 'currency', currency: 'PHP', minimumFractionDigits: 2, maximumFractionDigits: 2}).format(num);
            },
            fmtDate: (str) => {
                if (!str) return '';
                try { return new Date(str).toLocaleDateString('en-PH'); } catch (e) { return str; }
            },
            isInDateRange: (dateStr, from, to) => {
                if (!dateStr) return false;
                if (!from && !to) return true;
                try {
                    const d = new Date(dateStr);
                    d.setHours(0, 0, 0, 0);
                    if (from) {
                        const fromDate = new Date(from);
                        fromDate.setHours(0, 0, 0, 0);
                        if (d < fromDate) return false;
                    }
                    if (to) {
                        const toDate = new Date(to);
                        toDate.setHours(23, 59, 59, 999);
                        if (d > toDate) return false;
                    }
                    return true;
                } catch (e) { return false; }
            },
            getDateRangeFromPreset: (preset) => {
                const today = new Date(), from = new Date(), to = new Date();
                try {
                    switch(preset) {
                        case 'thisWeek': from.setDate(today.getDate() - today.getDay()); break;
                        case 'thisMonth': from.setDate(1); break;
                        case 'lastMonth': from.setMonth(today.getMonth() - 1); from.setDate(1); to.setDate(0); break;
                        case 'last3Months': from.setMonth(today.getMonth() - 3); break;
                        case 'thisYear': from.setMonth(0); from.setDate(1); break;
                        case 'all': return {from: null, to: null};
                        default: from.setDate(1);
                    }
                    from.setHours(0, 0, 0, 0);
                    to.setHours(23, 59, 59, 999);
                    return {from: from.toISOString().split('T')[0], to: to.toISOString().split('T')[0]};
                } catch (e) { return {from: null, to: null}; }
            },
            getCategoryById: (id) => id ? Store.state.categories.find(c => c.id === id) || null : null,
            getAccountById: (id) => id ? Store.state.accounts.find(a => a.id === id) || null : null,
            getCategoryName: (id) => {const cat = Utils.getCategoryById(id); return cat ? cat.name : 'Uncategorized';},
            getAccountName: (id) => {const acc = Utils.getAccountById(id); return acc ? acc.name : 'Unknown';},
            getMonthlyData: () => {
                const months = [], now = new Date();
                const nowMonth = now.getMonth(), nowYear = now.getFullYear();
                try {
                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(nowYear, nowMonth - i, 1);
                        const year = d.getFullYear(), month = d.getMonth();
                        const txs = Store.state.transactions.filter(t => {
                            const td = new Date(t.date);
                            return td.getMonth() === month && td.getFullYear() === year;
                        });
                        const spent = Utils.roundMoney(Math.abs(txs.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)));
                        const income = Utils.roundMoney(txs.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                        months.push({
                            date: d,
                            label: d.toLocaleString('default', {month: 'short', year: '2-digit'}),
                            spent, income,
                            isCurrent: month === nowMonth && year === nowYear
                        });
                    }
                } catch (e) { console.error('Monthly data error:', e); }
                return months;
            },
            calculateNetWorth: () => {
                let total = 0;
                Store.state.accounts.forEach(acc => {
                    if (acc.type === 'credit') total -= Math.abs(acc.balance);
                    else total += acc.balance;
                });
                return Utils.roundMoney(total);
            },
            calculateLiquidAssets: () => {
                let total = 0;
                Store.state.accounts.forEach(acc => {
                    if (acc.type !== 'investment' && acc.type !== 'credit') total += acc.balance;
                });
                return Utils.roundMoney(total);
            }
        };

        /* --- APP --- */
        const App = {
            eventListeners: [], // ‚úÖ NEW: Track listeners to prevent leaks

            init() {
                try {
                    Store.init();
                    if (Store.state.theme === 'dark') {
                        document.body.classList.add('dark-mode');
                        const themeBtn = document.getElementById('toggleTheme');
                        if (themeBtn) themeBtn.textContent = '‚òÄÔ∏è';
                    }
                    if (Store.state.privacyMode) document.body.classList.add('privacy-mode');
                    this.applyDatePreset(Store.state.dateFilter.preset || 'thisMonth');
                    const txDate = document.getElementById('txDate');
                    const recurringStartDate = document.getElementById('recurringStartDate');
                    if (txDate) txDate.valueAsDate = new Date();
                    if (recurringStartDate) recurringStartDate.valueAsDate = new Date();
                    this.bindEvents();
                    this.initColorPickers();
                    this.render(['all']);
                    
                    // ‚úÖ FIX: Process recurring AFTER initial render
                    setTimeout(() => {
                        Store.processRecurringTransactions();
                    }, 500);
                } catch (error) {
                    console.error('Init error:', error);
                    alert('Failed to initialize');
                }
            },
            
            initColorPickers() {
                [['newCatColorPicker', 'newCatColor'], ['accountColorPicker', 'accountColor']].forEach(([pickerId, inputId]) => {
                    const picker = document.getElementById(pickerId);
                    if (!picker) return;
                    picker.innerHTML = '';
                    COLOR_PALETTE.forEach((color, idx) => {
                        const div = document.createElement('div');
                        div.className = 'color-option' + (idx === 0 ? ' selected' : '');
                        div.style.background = color;
                        div.onclick = () => {
                            picker.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                            div.classList.add('selected');
                            const input = document.getElementById(inputId);
                            if (input) input.value = color;
                        };
                        picker.appendChild(div);
                    });
                });
            },

            // ‚úÖ NEW: Cleanup event listeners
            cleanupListeners() {
                this.eventListeners.forEach(({element, event, handler}) => {
                    try {
                        element.removeEventListener(event, handler);
                    } catch(e) {}
                });
                this.eventListeners = [];
            },

            addListener(element, event, handler) {
                if (!element) return;
                element.addEventListener(event, handler);
                this.eventListeners.push({element, event, handler});
            },

            bindEvents() {
                this.cleanupListeners(); // ‚úÖ FIX: Prevent memory leaks
                
                // Navigation
                document.querySelectorAll('.nav-item').forEach(el => {
                    this.addListener(el, 'click', (e) => {
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                        e.target.classList.add('active');
                        const section = document.getElementById(e.target.dataset.tab);
                        if (section) section.classList.remove('hidden');
                        if (e.target.dataset.tab === 'compare') this.initComparison();
                    });
                });
                
                // Date filters
                document.querySelectorAll('[data-preset]').forEach(btn => {
                    this.addListener(btn, 'click', (e) => this.applyDatePreset(e.target.dataset.preset));
                });
                
                this.addListener(document.getElementById('applyDateFilter'), 'click', () => {
                    const from = document.getElementById('dateFrom').value;
                    const to = document.getElementById('dateTo').value;
                    Store.setDateFilter(from, to, 'custom');
                    document.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));
                    this.render(['all']);
                });
                
                this.addListener(document.getElementById('clearDateFilter'), 'click', () => this.applyDatePreset('thisMonth'));

                // Transaction modal
                this.addListener(document.getElementById('openAddTxModal'), 'click', () => {
                    const form = document.getElementById('txForm');
                    if (form) form.reset();
                    document.getElementById('txDate').valueAsDate = new Date();
                    document.getElementById('txType').value = 'expense';
                    ['typeExpense', 'typeIncome', 'typeTransfer'].forEach(id => {
                        const btn = document.getElementById(id);
                        if (id === 'typeExpense') {
                            btn.classList.add('btn-primary');
                            btn.classList.remove('btn-outline');
                        } else {
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-outline');
                        }
                    });
                    document.getElementById('categorySelectContainer').classList.remove('hidden');
                    document.getElementById('transferToContainer').classList.add('hidden');
                    document.getElementById('txModal').showModal();
                });

                // Transaction form
                this.addListener(document.getElementById('txForm'), 'submit', (e) => {
                    e.preventDefault();
                    const type = document.getElementById('txType').value;
                    const amount = parseFloat(document.getElementById('txAmount').value);
                    const date = document.getElementById('txDate').value;
                    const desc = document.getElementById('txDesc').value.trim();
                    const accountId = document.getElementById('txAccount').value;
                    const category = document.getElementById('txCategory').value;
                    const reconciled = document.getElementById('txReconciled').checked;
                    
                    if (!accountId) {alert('Select account'); return;}
                    
                    let txData = {date, desc, accountId, amount, reconciled};
                    
                    // ‚úÖ FIX: Handle transfer as transfer_out
                    if (type === 'transfer') {
                        const transferTo = document.getElementById('txTransferTo').value;
                        if (!transferTo) {alert('Select destination account'); return;}
                        if (transferTo === accountId) {alert('Cannot transfer to same account'); return;}
                        txData.type = 'transfer_out';
                        txData.transferTo = transferTo;
                        txData.category = null;
                    } else {
                        txData.type = type;
                        if (type === 'expense') {
                            if (!category) {alert('Select category'); return;}
                            txData.category = category;
                        } else {
                            txData.category = null;
                        }
                    }
                    
                    if (Store.addTransaction(txData)) document.getElementById('txModal').close();
                });

                // Transaction type toggle
                ['typeExpense', 'typeIncome', 'typeTransfer'].forEach(btnId => {
                    this.addListener(document.getElementById(btnId), 'click', () => {
                        const type = btnId.replace('type', '').toLowerCase();
                        ['typeExpense', 'typeIncome', 'typeTransfer'].forEach(id => {
                            const btn = document.getElementById(id);
                            if (id === btnId) {
                                btn.classList.add('btn-primary');
                                btn.classList.remove('btn-outline');
                            } else {
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-outline');
                            }
                        });
                        document.getElementById('txType').value = type;
                        document.getElementById('categorySelectContainer').classList.toggle('hidden', type !== 'expense');
                        document.getElementById('transferToContainer').classList.toggle('hidden', type !== 'transfer');
                    });
                });

                // Filters
                ['searchTx', 'filterAccount', 'filterCategory', 'filterType'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) this.addListener(el, id === 'searchTx' ? 'input' : 'change', () => this.render(['transactions']));
                });

                // Privacy & Theme
                this.addListener(document.getElementById('togglePrivacy'), 'click', () => {
                    Store.state.privacyMode = !Store.state.privacyMode;
                    document.body.classList.toggle('privacy-mode', Store.state.privacyMode);
                    Store.save(true);
                });
                
                this.addListener(document.getElementById('toggleTheme'), 'click', (e) => {
                    const theme = Store.toggleTheme();
                    document.body.classList.toggle('dark-mode', theme === 'dark');
                    e.target.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                });

                // Export
                this.addListener(document.getElementById('exportBtn'), 'click', () => document.getElementById('exportModal').showModal());
                this.addListener(document.getElementById('exportCurrentCSV'), 'click', () => {this.exportCSV('current'); document.getElementById('exportModal').close();});
                this.addListener(document.getElementById('exportAllCSV'), 'click', () => {this.exportCSV('all'); document.getElementById('exportModal').close();});
                this.addListener(document.getElementById('exportAccountsCSV'), 'click', () => {this.exportAccounts(); document.getElementById('exportModal').close();});
                this.addListener(document.getElementById('exportMonthlyReport'), 'click', () => {this.exportMonthlyReport(); document.getElementById('exportModal').close();});

                // ‚úÖ NEW: Backup/Restore
                this.addListener(document.getElementById('backupBtn'), 'click', () => document.getElementById('backupModal').showModal());
                this.addListener(document.getElementById('exportBackupBtn'), 'click', () => {this.exportFullBackup(); document.getElementById('backupModal').close();});
                this.addListener(document.getElementById('importBackupFile'), 'change', (e) => {
                    if (e.target.files[0]) this.importBackup(e.target.files[0]);
                });

                // Planning
                this.addListener(document.getElementById('monthlyIncome'), 'change', (e) => {
                    const income = parseFloat(e.target.value);
                    if (isNaN(income) || income < 0) {e.target.value = Store.state.income; return;}
                    Store.state.income = Utils.roundMoney(income);
                    Store.save(false, ['planning']);
                });

                this.addListener(document.getElementById('addCategoryForm'), 'submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('newCatName').value.trim();
                    const group = document.getElementById('newCatGroup').value;
                    const color = document.getElementById('newCatColor').value;
                    if (Store.addCategory(name, group, color)) {
                        e.target.reset();
                        document.getElementById('newCatColor').value = COLOR_PALETTE[0];
                        this.initColorPickers();
                    }
                });
                
                // Accounts
                this.addListener(document.getElementById('addAccountBtn'), 'click', () => {
                    const form = document.getElementById('accountForm');
                    if (form) form.reset();
                    document.getElementById('accountId').value = '';
                    document.getElementById('accountModalTitle').textContent = 'Add Account';
                    document.getElementById('accountColor').value = COLOR_PALETTE[0];
                    this.initColorPickers();
                    document.getElementById('accountModal').showModal();
                });
                
                // ‚úÖ FIX: Enhanced account validation
                this.addListener(document.getElementById('accountForm'), 'submit', (e) => {
                    e.preventDefault();
                    
                    const balance = parseFloat(document.getElementById('accountBalance').value);
                    const goalBalance = document.getElementById('accountGoal').value ? parseFloat(document.getElementById('accountGoal').value) : null;
                    const threshold = document.getElementById('accountThreshold').value ? parseFloat(document.getElementById('accountThreshold').value) : null;
                    
                    if (isNaN(balance)) {alert('Please enter a valid balance'); return;}
                    if (goalBalance !== null && (isNaN(goalBalance) || goalBalance <= 0)) {alert('Goal balance must be a positive number'); return;}
                    if (threshold !== null && (isNaN(threshold) || threshold < 0)) {alert('Threshold must be a non-negative number'); return;}
                    if (goalBalance && threshold && threshold > goalBalance) {
                        if (!confirm('Low balance threshold is higher than goal. Continue?')) return;
                    }
                    
                    const account = {
                        id: document.getElementById('accountId').value || undefined,
                        name: document.getElementById('accountName').value.trim(),
                        type: document.getElementById('accountType').value,
                        institution: document.getElementById('accountInstitution').value.trim(),
                        balance, goalBalance, lowBalanceThreshold: threshold,
                        color: document.getElementById('accountColor').value
                    };
                    
                    if (Store.addAccount(account)) document.getElementById('accountModal').close();
                });
                
                // Recurring
                this.addListener(document.getElementById('addRecurringBtn'), 'click', () => {
                    const form = document.getElementById('recurringForm');
                    if (form) form.reset();
                    document.getElementById('recurringId').value = '';
                    document.getElementById('recurringModalTitle').textContent = 'Add Recurring';
                    document.getElementById('recurringStartDate').valueAsDate = new Date();
                    document.getElementById('recurringModal').showModal();
                });
                
                this.addListener(document.getElementById('recurringForm'), 'submit', (e) => {
                    e.preventDefault();
                    const recurring = {
                        id: document.getElementById('recurringId').value || undefined,
                        description: document.getElementById('recurringDesc').value.trim(),
                        amount: parseFloat(document.getElementById('recurringAmount').value),
                        accountId: document.getElementById('recurringAccount').value,
                        category: document.getElementById('recurringCategory').value,
                        frequency: document.getElementById('recurringFrequency').value,
                        dayOfMonth: parseInt(document.getElementById('recurringDay').value),
                        startDate: document.getElementById('recurringStartDate').value,
                        active: document.getElementById('recurringActive').checked
                    };
                    if (Store.addRecurringTransaction(recurring)) document.getElementById('recurringModal').close();
                });
                
                this.addListener(document.getElementById('runComparisonBtn'), 'click', () => this.runComparison());
            },
            
            applyDatePreset(preset) {
                const range = Utils.getDateRangeFromPreset(preset);
                Store.setDateFilter(range.from, range.to, preset);
                const fromInput = document.getElementById('dateFrom');
                const toInput = document.getElementById('dateTo');
                if (fromInput) fromInput.value = range.from || '';
                if (toInput) toInput.value = range.to || '';
                document.querySelectorAll('[data-preset]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.preset === preset);
                });
                this.render(['all']);
            },

            // ‚úÖ FIX: Selective rendering for performance
            render(sections = ['all']) {
                const renderMap = {
                    dashboard: () => this.renderDashboard(),
                    accounts: () => this.renderAccounts(),
                    transactions: () => this.renderTransactions(),
                    planning: () => this.renderPlanning(),
                    insights: () => this.renderInsights(),
                    recurring: () => this.renderRecurring(),
                    dropdowns: () => this.updateDropdowns()
                };
                
                if (sections.includes('all')) {
                    Object.values(renderMap).forEach(fn => {
                        try { fn(); } catch (e) { console.error('Render error:', e); }
                    });
                } else {
                    sections.forEach(section => {
                        try { renderMap[section]?.(); } catch (e) { console.error(`${section} render error:`, e); }
                    });
                    // Always update dropdowns
                    try { renderMap.dropdowns(); } catch (e) {}
                }
            },

            getFilteredTransactions() {
                const {from, to} = Store.state.dateFilter;
                return Store.state.transactions.filter(t => Utils.isInDateRange(t.date, from, to));
            },

            getMetrics() {
                const filteredTx = this.getFilteredTransactions();
                const sortedTx = [...Store.state.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
                const totalSpent = Utils.roundMoney(Math.abs(filteredTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)));
                const totalIncome = Utils.roundMoney(filteredTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                const netBalance = Utils.roundMoney(totalIncome - totalSpent);
                const savingsRate = totalIncome > 0 ? Utils.roundPercentage((netBalance / totalIncome) * 100) : 0;
                return {filteredTx, sortedTx, totalSpent, totalIncome, netBalance, savingsRate};
            },

            renderDashboard() {
                const netWorth = Utils.calculateNetWorth();
                const liquid = Utils.calculateLiquidAssets();
                const el1 = document.getElementById('dashNetWorth');
                const el2 = document.getElementById('dashLiquid');
                if (el1) el1.textContent = Utils.fmtMoney(netWorth);
                if (el2) el2.textContent = Utils.fmtMoney(liquid);
                
                const {filteredTx, sortedTx, totalSpent, totalIncome, netBalance, savingsRate} = this.getMetrics();
                
                const els = {
                    dashTotalIncome: totalIncome,
                    dashTotalSpent: totalSpent,
                    dashNet: netBalance,
                    dashSavingsRate: savingsRate + '%'
                };
                
                Object.entries(els).forEach(([id, val]) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = typeof val === 'number' ? Utils.fmtMoney(val) : val;
                });
                
                const dashNet = document.getElementById('dashNet');
                if (dashNet) dashNet.className = 'text-xl private-data ' + (netBalance >= 0 ? 'text-success' : 'text-danger');
                
                // Alerts
                const alerts = document.getElementById('budgetAlerts');
                if (alerts) {
                    alerts.innerHTML = '';
                    Store.state.categories.forEach(cat => {
                        const spent = Utils.roundMoney(Math.abs(filteredTx.filter(t => t.type === 'expense' && t.category === cat.id).reduce((sum, t) => sum + t.amount, 0)));
                        if (cat.limit > 0 && spent > cat.limit) {
                            alerts.innerHTML += `<div class="alert alert-danger"><strong>‚ö†Ô∏è Alert:</strong> ${cat.name} exceeded by ${Utils.fmtMoney(spent - cat.limit)}</div>`;
                        } else if (cat.limit > 0 && spent > cat.limit * 0.9) {
                            alerts.innerHTML += `<div class="alert alert-warning"><strong>‚ö†Ô∏è Warning:</strong> ${cat.name} at ${Utils.roundPercentage((spent/cat.limit)*100)}%</div>`;
                        }
                    });
                    Store.state.accounts.forEach(acc => {
                        if (acc.lowBalanceThreshold && acc.balance < acc.lowBalanceThreshold) {
                            alerts.innerHTML += `<div class="alert alert-warning"><strong>üí∞ Low Balance:</strong> ${acc.name} (${Utils.fmtMoney(acc.balance)})</div>`;
                        }
                    });
                }

                // Budget bars
                const bars = document.getElementById('budgetBars');
                if (bars) {
                    bars.innerHTML = '';
                    Store.state.categories.forEach(cat => {
                        const spent = Utils.roundMoney(Math.abs(filteredTx.filter(t => t.type === 'expense' && t.category === cat.id).reduce((sum, t) => sum + t.amount, 0)));
                        if (cat.limit === 0 && spent === 0) return;
                        const pct = cat.limit > 0 ? (spent / cat.limit) * 100 : 100;
                        const color = pct > 100 ? 'bg-red' : pct > 80 ? 'bg-yellow' : 'bg-green';
                        bars.innerHTML += `
                            <div>
                                <div class="flex flex-between text-sm mb-1">
                                    <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${cat.color};margin-right:6px;"></span>${cat.name}</span>
                                    <span class="private-data">${Utils.fmtMoney(spent)} / ${Utils.fmtMoney(cat.limit)}</span>
                                </div>
                                <div class="progress-track"><div class="progress-fill ${color}" style="width:${Math.min(pct,100)}%"></div></div>
                            </div>
                        `;
                    });
                }

                // Recent transactions
                const recent = document.getElementById('recentList');
                if (recent) {
                    recent.innerHTML = '';
                    const list = sortedTx.slice(0, 5);
                    if (list.length === 0) recent.innerHTML = '<div class="text-sm text-center">No transactions yet</div>';
                    list.forEach(t => {
                        const catName = t.type === 'income' ? 'Income' : t.type === 'transfer_out' ? 'Transfer Out' : t.type === 'transfer_in' ? 'Transfer In' : Utils.getCategoryName(t.category);
                        const accName = Utils.getAccountName(t.accountId);
                        recent.innerHTML += `
                            <div class="card" style="padding:0.75rem;">
                                <div class="flex flex-between">
                                    <div>
                                        <div style="font-weight:bold;">${t.desc}${t.recurring?'<span class="recurring-badge">‚Üª</span>':''}${t.type==='transfer_out' || t.type==='transfer_in'?'<span class="transfer-badge">‚áÑ</span>':''}${t.reconciled?'<span class="reconciled-badge">‚úì</span>':''}</div>
                                        <div class="text-sm">${Utils.fmtDate(t.date)} ‚Ä¢ ${accName} ‚Ä¢ ${catName}</div>
                                    </div>
                                    <div class="${t.type==='expense'?'text-danger':t.type==='transfer_out' || t.type==='transfer_in'?'text-info':'text-success'} private-data">
                                        ${t.type==='expense'?'-':t.type==='transfer_out' || t.type==='transfer_in'?'‚áÑ':'+'}${Utils.fmtMoney(Math.abs(t.amount))}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                this.renderAccountSummary();
                this.renderMonthlyCalendar();
            },
            
            renderAccountSummary() {
                const container = document.getElementById('accountSummary');
                if (!container) return;
                container.innerHTML = '';
                if (Store.state.accounts.length === 0) {
                    container.innerHTML = '<div class="text-sm text-center">No accounts yet</div>';
                    return;
                }
                Store.state.accounts.slice(0, 5).forEach(acc => {
                    const low = acc.lowBalanceThreshold && acc.balance < acc.lowBalanceThreshold;
                    container.innerHTML += `
                        <div class="mb-2">
                            <div class="flex flex-between text-sm mb-1">
                                <span>${ACCOUNT_ICONS[acc.type]||'üí∞'} ${acc.name}${low?' ‚ö†Ô∏è':''}</span>
                                <span class="private-data ${acc.type==='credit'?'text-danger':''}">${Utils.fmtMoney(acc.balance)}</span>
                            </div>
                            ${acc.goalBalance?`<div class="progress-track"><div class="progress-fill bg-info" style="width:${Math.min((acc.balance/acc.goalBalance)*100,100)}%"></div></div>`:''}
                        </div>
                    `;
                });
            },
            
            renderMonthlyCalendar() {
                const container = document.getElementById('monthlyCalendar');
                if (!container) return;
                container.innerHTML = '';
                container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                Utils.getMonthlyData().forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'month-item' + (m.isCurrent ? ' current' : '');
                    div.innerHTML = `
                        <div style="font-weight:600;margin-bottom:4px;">${m.label}</div>
                        <div class="text-sm">Spent: <span class="private-data text-danger">${Utils.fmtMoney(m.spent)}</span></div>
                        <div class="text-sm">Income: <span class="private-data text-success">${Utils.fmtMoney(m.income)}</span></div>
                    `;
                    div.onclick = () => {
                        const y = m.date.getFullYear(), mo = m.date.getMonth();
                        const from = new Date(y, mo, 1).toISOString().split('T')[0];
                        const to = new Date(y, mo + 1, 0).toISOString().split('T')[0];
                        Store.setDateFilter(from, to, 'custom');
                        document.getElementById('dateFrom').value = from;
                        document.getElementById('dateTo').value = to;
                        document.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));
                        this.render(['all']);
                    };
                    container.appendChild(div);
                });
            },
            
            renderAccounts() {
                let assets = 0, liabilities = 0;
                Store.state.accounts.forEach(acc => {
                    if (acc.type === 'credit') liabilities += Math.abs(acc.balance);
                    else assets += acc.balance;
                });
                const netWorth = Utils.roundMoney(assets - liabilities);
                
                ['totalAssets', 'totalLiabilities', 'netWorthDisplay'].forEach((id, i) => {
                    const el = document.getElementById(id);
                    if (el) {
                        const val = [assets, liabilities, netWorth][i];
                        el.textContent = Utils.fmtMoney(val);
                        if (i === 2) el.className = 'text-xl private-data ' + (netWorth >= 0 ? 'text-success' : 'text-danger');
                    }
                });
                
                const alerts = document.getElementById('accountAlerts');
                if (alerts) {
                    alerts.innerHTML = '';
                    Store.state.accounts.forEach(acc => {
                        if (acc.lowBalanceThreshold && acc.balance < acc.lowBalanceThreshold) {
                            alerts.innerHTML += `<div class="alert alert-warning"><strong>‚ö†Ô∏è</strong> ${acc.name} below threshold</div>`;
                        }
                        if (acc.goalBalance && acc.balance >= acc.goalBalance) {
                            alerts.innerHTML += `<div class="alert alert-success"><strong>üéâ</strong> ${acc.name} reached goal!</div>`;
                        }
                    });
                }
                
                const list = document.getElementById('accountsList');
                if (list) {
                    list.innerHTML = '';
                    if (Store.state.accounts.length === 0) {
                        list.innerHTML = '<div class="text-sm text-center" style="padding:2rem;">No accounts yet</div>';
                        return;
                    }
                    Store.state.accounts.forEach(acc => {
                        const low = acc.lowBalanceThreshold && acc.balance < acc.lowBalanceThreshold;
                        list.innerHTML += `
                            <div class="account-card${low?' low-balance':''}">
                                <div class="flex flex-between mb-2">
                                    <div class="flex gap-2 items-center">
                                        <div class="account-icon" style="background:${acc.color}20;color:${acc.color};">${ACCOUNT_ICONS[acc.type]||'üí∞'}</div>
                                        <div>
                                            <div style="font-weight:600;">${acc.name}</div>
                                            <div class="text-xs">${acc.institution||acc.type}</div>
                                        </div>
                                    </div>
                                    <span class="badge badge-${acc.type}">${acc.type}</span>
                                </div>
                                <div class="flex flex-between mb-2">
                                    <span class="text-sm">Balance:</span>
                                    <span class="private-data text-xl ${acc.type==='credit'?'text-danger':''}">${Utils.fmtMoney(acc.balance)}</span>
                                </div>
                                ${acc.goalBalance?`<div class="mb-2"><div class="flex flex-between text-xs mb-1"><span>Goal</span><span>${Math.min((acc.balance/acc.goalBalance)*100,100).toFixed(0)}%</span></div><div class="progress-track"><div class="progress-fill bg-info" style="width:${Math.min((acc.balance/acc.goalBalance)*100,100)}%"></div></div></div>`:''}
                                <div class="flex gap-2 mt-3">
                                    <button class="btn-sm btn-outline flex-1" onclick="App.editAccount('${acc.id}')">Edit</button>
                                    <button class="btn-sm btn-danger" onclick="App.deleteAccount('${acc.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                this.renderAccountDistribution();
            },
            
            renderAccountDistribution() {
                const container = document.getElementById('accountDistribution');
                if (!container) return;
                container.innerHTML = '';
                if (Store.state.accounts.length === 0) {
                    container.innerHTML = '<div class="text-sm text-center">No accounts yet</div>';
                    return;
                }
                const total = Store.state.accounts.filter(a => a.type !== 'credit').reduce((sum, a) => sum + Math.abs(a.balance), 0);
                if (total === 0) {
                    container.innerHTML = '<div class="text-sm text-center">No positive balances</div>';
                    return;
                }
                Store.state.accounts.filter(a => a.type !== 'credit' && a.balance > 0).sort((a,b) => b.balance - a.balance).forEach(acc => {
                    const pct = (acc.balance / total) * 100;
                    container.innerHTML += `
                        <div class="mb-3">
                            <div class="flex flex-between text-sm mb-1">
                                <span>${ACCOUNT_ICONS[acc.type]} ${acc.name}</span>
                                <span class="private-data">${pct.toFixed(1)}% (${Utils.fmtMoney(acc.balance)})</span>
                            </div>
                            <div class="progress-track"><div class="progress-fill" style="width:${pct}%;background:${acc.color};"></div></div>
                        </div>
                    `;
                });
            },
            
            editAccount(id) {
                const acc = Utils.getAccountById(id);
                if (!acc) return;
                document.getElementById('accountId').value = acc.id;
                document.getElementById('accountName').value = acc.name;
                document.getElementById('accountType').value = acc.type;
                document.getElementById('accountInstitution').value = acc.institution || '';
                document.getElementById('accountBalance').value = acc.balance;
                document.getElementById('accountGoal').value = acc.goalBalance || '';
                document.getElementById('accountThreshold').value = acc.lowBalanceThreshold || '';
                document.getElementById('accountColor').value = acc.color;
                document.getElementById('accountModalTitle').textContent = 'Edit Account';
                this.initColorPickers();
                document.getElementById('accountModal').showModal();
            },
            
            deleteAccount(id) {
                if (confirm('Delete this account?')) Store.deleteAccount(id);
            },

            renderTransactions() {
                const tbody = document.getElementById('txTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                const search = document.getElementById('searchTx')?.value.toLowerCase() || '';
                const filterAcc = document.getElementById('filterAccount')?.value || 'all';
                const filterCat = document.getElementById('filterCategory')?.value || 'all';
                const filterType = document.getElementById('filterType')?.value || 'all';

                // ‚úÖ FIX: Optimized filtering
                let txs = this.getFilteredTransactions()
                    .filter(t => {
                        if (search && !t.desc.toLowerCase().includes(search)) return false;
                        if (filterAcc !== 'all' && t.accountId !== filterAcc) return false;
                        if (filterCat !== 'all' && t.category !== filterCat) return false;
                        if (filterType !== 'all' && t.type !== filterType) return false;
                        return true;
                    })
                    .sort((a,b) => new Date(b.date) - new Date(a.date));

                if (txs.length === 0) tbody.innerHTML = '<tr><td colspan="7" class="text-center">No transactions</td></tr>';
                
                txs.forEach(t => {
                    const cat = Utils.getCategoryById(t.category);
                    const acc = Utils.getAccountById(t.accountId);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${Utils.fmtDate(t.date)}</td>
                        <td>${t.desc}${t.recurring?'<span class="recurring-badge">‚Üª</span>':''}${t.type==='transfer_out' || t.type==='transfer_in'?'<span class="transfer-badge">‚áÑ</span>':''}</td>
                        <td>${acc?.name||'-'}</td>
                        <td>${t.type==='income'?'Income':t.type==='transfer_out'?'Transfer Out':t.type==='transfer_in'?'Transfer In':cat?.name||'-'}</td>
                        <td class="text-right private-data ${t.type==='expense'?'text-danger':t.type==='transfer_out' || t.type==='transfer_in'?'text-info':'text-success'}">
                            ${t.type==='expense'?'-':t.type==='transfer_out' || t.type==='transfer_in'?'‚áÑ':'+'}${Utils.fmtMoney(Math.abs(t.amount))}
                        </td>
                        <td class="text-center">
                            ${t.reconciled?'<span class="reconciled-badge">‚úì</span>':(!t.recurring?`<button class="btn-sm btn-outline" onclick="Store.toggleReconciled('${t.id}')">Clear</button>`:'')}
                        </td>
                        <td class="text-right">
                            ${!t.recurring?`<button class="btn-sm btn-danger" onclick="if(confirm('Delete?'))Store.deleteTransaction('${t.id}')">√ó</button>`:'<span class="text-xs">Auto</span>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                const summary = document.getElementById('transactionSummary');
                if (summary) {
                    const spent = Utils.roundMoney(Math.abs(txs.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)));
                    const income = Utils.roundMoney(txs.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                    const cleared = txs.filter(t => t.reconciled).length;
                    summary.innerHTML = `${txs.length} tx | Income: <span class="text-success private-data">${Utils.fmtMoney(income)}</span> | Expenses: <span class="text-danger private-data">${Utils.fmtMoney(spent)}</span> | Cleared: ${cleared}`;
                }
            },

            renderPlanning() {
                const incomeInput = document.getElementById('monthlyIncome');
                if (incomeInput) incomeInput.value = Store.state.income;
                
                const container = document.getElementById('categoryInputs');
                if (!container) return;
                container.innerHTML = '';
                let totalBudgeted = 0;
                const order = {'needs': 1, 'wants': 2, 'savings': 3};
                const sorted = [...Store.state.categories].sort((a,b) => order[a.group] - order[b.group]);
                sorted.forEach(cat => {
                    totalBudgeted += cat.limit;
                    container.innerHTML += `
                        <div class="flex flex-between items-center mb-2" style="padding:0.5rem;border-bottom:1px solid var(--border);">
                            <div class="flex gap-2 items-center">
                                <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${cat.color};"></span>
                                <span class="badge badge-${cat.group}">${cat.group}</span>
                                <span>${cat.name}</span>
                            </div>
                            <input type="number" value="${cat.limit}" onchange="Store.updateBudgetLimit('${cat.id}',this.value)" style="width:120px;text-align:right">
                        </div>
                    `;
                });
                const remaining = Utils.roundMoney(Store.state.income - totalBudgeted);
                const unEl = document.getElementById('unassignedMoney');
                if (unEl) {
                    unEl.textContent = Utils.fmtMoney(remaining);
                    unEl.className = remaining < 0 ? 'text-danger private-data' : 'text-success private-data';
                }
                
                const catList = document.getElementById('categoryList');
                if (catList) {
                    catList.innerHTML = '';
                    Store.state.categories.forEach(cat => {
                        catList.innerHTML += `
                            <div class="flex flex-between items-center" style="padding:0.5rem;border-bottom:1px solid var(--border);">
                                <div class="flex gap-2 items-center">
                                    <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${cat.color};cursor:pointer;" onclick="App.changeCategoryColor('${cat.id}')" title="Change color"></span>
                                    <span>${cat.name}</span>
                                </div>
                                <button class="btn-sm btn-danger" onclick="App.deleteCategory('${cat.id}')">Delete</button>
                            </div>
                        `;
                    });
                }
            },
            
            changeCategoryColor(id) {
                const color = prompt('Enter hex color (e.g., #FF5733):');
                if (color && Validators.isValidHexColor(color)) Store.updateCategory(id, {color});
                else if (color) alert('Invalid color format');
            },
            
            deleteCategory(id) {
                if (confirm('Delete this category?')) Store.deleteCategory(id);
            },

            renderInsights() {
                const {filteredTx} = this.getMetrics();
                
                // Group breakdown
                const groupData = {needs: 0, wants: 0, savings: 0};
                filteredTx.filter(t => t.type === 'expense').forEach(t => {
                    const cat = Utils.getCategoryById(t.category);
                    if (cat) groupData[cat.group] += Math.abs(t.amount);
                });
                const container = document.getElementById('groupBreakdown');
                if (container) {
                    container.innerHTML = '';
                    const total = Utils.roundMoney(groupData.needs + groupData.wants + groupData.savings);
                    if (total === 0) container.innerHTML = '<div class="text-sm text-center">No expenses</div>';
                    else {
                        Object.entries(groupData).forEach(([key, val]) => {
                            if (val === 0) return;
                            const pct = Utils.roundPercentage((val / total) * 100);
                            container.innerHTML += `
                                <div class="mb-2">
                                    <div class="flex flex-between text-sm">
                                        <span style="text-transform:capitalize;">${key}</span>
                                        <span class="private-data">${pct}% (${Utils.fmtMoney(val)})</span>
                                    </div>
                                    <div class="progress-track"><div class="progress-fill bg-primary" style="width:${pct}%"></div></div>
                                </div>
                            `;
                        });
                    }
                }

                // Trend chart
                const chart = document.getElementById('trendChart');
                if (chart) {
                    chart.innerHTML = '';
                    const months = Utils.getMonthlyData();
                    const maxSpent = Math.max(...months.map(m => m.spent), 1);
                    months.forEach(d => {
                        const pct = (d.spent / maxSpent) * 100;
                        chart.innerHTML += `<div class="chart-col private-data" style="height:${Math.max(pct,1)}%" title="${Utils.fmtMoney(d.spent)}"><span class="chart-label">${d.label}</span></div>`;
                    });
                }
                
                // Category breakdown
                const catContainer = document.getElementById('categoryBreakdown');
                if (catContainer) {
                    catContainer.innerHTML = '';
                    const catData = {};
                    filteredTx.filter(t => t.type === 'expense').forEach(t => {
                        const cat = Utils.getCategoryById(t.category);
                        if (cat) {
                            catData[cat.id] = catData[cat.id] || {name: cat.name, color: cat.color, total: 0};
                            catData[cat.id].total += Math.abs(t.amount);
                        }
                    });
                    const sorted = Object.values(catData).sort((a,b) => b.total - a.total).slice(0, 5);
                    const catTotal = sorted.reduce((sum, c) => sum + c.total, 0);
                    if (sorted.length === 0) catContainer.innerHTML = '<div class="text-sm text-center">No expenses</div>';
                    else {
                        sorted.forEach(cat => {
                            const pct = catTotal > 0 ? Utils.roundPercentage((cat.total / catTotal) * 100) : 0;
                            catContainer.innerHTML += `
                                <div class="mb-2">
                                    <div class="flex flex-between text-sm">
                                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${cat.color};margin-right:6px;"></span>${cat.name}</span>
                                        <span class="private-data">${pct}% (${Utils.fmtMoney(cat.total)})</span>
                                    </div>
                                    <div class="progress-track"><div class="progress-fill" style="width:${pct}%;background:${cat.color};"></div></div>
                                </div>
                            `;
                        });
                    }
                }
                
                // Weekly chart
                const weekly = document.getElementById('weeklyChart');
                if (weekly) {
                    weekly.innerHTML = '';
                    const weeks = [];
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    for (let i = 7; i >= 0; i--) {
                        const start = new Date(now);
                        start.setDate(now.getDate() - (i * 7));
                        start.setDate(start.getDate() - start.getDay());
                        start.setHours(0, 0, 0, 0);
                        const end = new Date(start);
                        end.setDate(start.getDate() + 6);
                        end.setHours(23, 59, 59, 999);
                        const txs = Store.state.transactions.filter(t => {
                            const d = new Date(t.date);
                            d.setHours(0, 0, 0, 0);
                            return d >= start && d <= end && t.type === 'expense';
                        });
                        const spent = Utils.roundMoney(Math.abs(txs.reduce((sum, t) => sum + t.amount, 0)));
                        weeks.push({label: `${start.getDate()}/${start.getMonth()+1}`, spent});
                    }
                    const maxSpent = Math.max(...weeks.map(w => w.spent), 1);
                    weeks.forEach(w => {
                        const pct = (w.spent / maxSpent) * 100;
                        weekly.innerHTML += `<div class="chart-col private-data" style="height:${Math.max(pct,1)}%" title="${Utils.fmtMoney(w.spent)}"><span class="chart-label">${w.label}</span></div>`;
                    });
                }
                
                // Balance history
                const history = document.getElementById('balanceHistoryChart');
                if (history) {
                    history.innerHTML = '<div class="text-sm text-center" style="line-height:150px;">Balance history coming soon</div>';
                }
            },
            
            renderRecurring() {
                const list = document.getElementById('recurringList');
                if (!list) return;
                list.innerHTML = '';
                if (Store.state.recurringTransactions.length === 0) {
                    list.innerHTML = '<div class="text-sm text-center" style="padding:2rem;">No recurring transactions yet</div>';
                    return;
                }
                Store.state.recurringTransactions.forEach(r => {
                    const cat = Utils.getCategoryById(r.category);
                    const acc = Utils.getAccountById(r.accountId);
                    list.innerHTML += `
                        <div class="card" style="padding:1rem;">
                            <div class="flex flex-between">
                                <div>
                                    <div style="font-weight:600;">${r.description}</div>
                                    <div class="text-sm">${Utils.fmtMoney(r.amount)} ‚Ä¢ ${acc?.name||'?'} ‚Ä¢ ${cat?.name||'?'} ‚Ä¢ ${r.frequency}${r.frequency==='monthly'?` (Day ${r.dayOfMonth})`:''}</div>
                                    <div class="text-xs">Started: ${Utils.fmtDate(r.startDate)}${r.lastProcessed?` ‚Ä¢ Last: ${Utils.fmtDate(r.lastProcessed)}`:''}</div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <span class="badge ${r.active?'badge-savings':'badge-wants'}">${r.active?'Active':'Paused'}</span>
                                    <button class="btn-sm btn-outline" onclick="App.editRecurring('${r.id}')">Edit</button>
                                    <button class="btn-sm btn-danger" onclick="if(confirm('Delete?'))Store.deleteRecurringTransaction('${r.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            },
            
            editRecurring(id) {
                const r = Store.state.recurringTransactions.find(rec => rec.id === id);
                if (!r) return;
                document.getElementById('recurringId').value = r.id;
                document.getElementById('recurringDesc').value = r.description;
                document.getElementById('recurringAmount').value = r.amount;
                document.getElementById('recurringAccount').value = r.accountId;
                document.getElementById('recurringCategory').value = r.category;
                document.getElementById('recurringFrequency').value = r.frequency;
                document.getElementById('recurringDay').value = r.dayOfMonth || 1;
                document.getElementById('recurringStartDate').value = r.startDate;
                document.getElementById('recurringActive').checked = r.active;
                document.getElementById('recurringModalTitle').textContent = 'Edit Recurring';
                document.getElementById('recurringModal').showModal();
            },
            
            initComparison() {
                const now = new Date();
                const m1 = new Date(now.getFullYear(), now.getMonth(), 1);
                const m1End = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const m2 = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const m2End = new Date(now.getFullYear(), now.getMonth(), 0);
                document.getElementById('compare1From').value = m1.toISOString().split('T')[0];
                document.getElementById('compare1To').value = m1End.toISOString().split('T')[0];
                document.getElementById('compare2From').value = m2.toISOString().split('T')[0];
                document.getElementById('compare2To').value = m2End.toISOString().split('T')[0];
            },
            
            runComparison() {
                const p1F = document.getElementById('compare1From').value;
                const p1T = document.getElementById('compare1To').value;
                const p2F = document.getElementById('compare2From').value;
                const p2T = document.getElementById('compare2To').value;
                if (!p1F || !p1T || !p2F || !p2T) {alert('Select both ranges'); return;}
                
                const p1Tx = Store.state.transactions.filter(t => Utils.isInDateRange(t.date, p1F, p1T));
                const p2Tx = Store.state.transactions.filter(t => Utils.isInDateRange(t.date, p2F, p2T));
                const p1S = Utils.roundMoney(Math.abs(p1Tx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)));
                const p2S = Utils.roundMoney(Math.abs(p2Tx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)));
                const p1I = Utils.roundMoney(p1Tx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                const p2I = Utils.roundMoney(p2Tx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                const sDiff = Utils.roundMoney(p1S - p2S); // ‚úÖ FIX: Rounded
                const iDiff = Utils.roundMoney(p1I - p2I); // ‚úÖ FIX: Rounded
                const sPct = p2S > 0 ? ((sDiff / p2S) * 100).toFixed(1) : (p1S > 0 ? '‚àû' : '0');
                const iPct = p2I > 0 ? ((iDiff / p2I) * 100).toFixed(1) : (p1I > 0 ? '‚àû' : '0');
                
                const container = document.getElementById('comparisonResults');
                if (!container) return;
                container.innerHTML = `
                    <div class="comparison-container">
                        <div class="card comparison-card">
                            <h3>Period 1</h3>
                            <div class="text-sm mb-2">${Utils.fmtDate(p1F)} - ${Utils.fmtDate(p1T)}</div>
                            <div class="mt-4">
                                <div>Income: <span class="text-success private-data text-xl">${Utils.fmtMoney(p1I)}</span></div>
                                <div>Expenses: <span class="text-danger private-data text-xl">${Utils.fmtMoney(p1S)}</span></div>
                                <div>Net: <span class="private-data text-xl ${p1I-p1S>=0?'text-success':'text-danger'}">${Utils.fmtMoney(Utils.roundMoney(p1I-p1S))}</span></div>
                                <div class="text-sm">Transactions: ${p1Tx.length}</div>
                            </div>
                        </div>
                        <div class="card comparison-card">
                            <h3>Period 2</h3>
                            <div class="text-sm mb-2">${Utils.fmtDate(p2F)} - ${Utils.fmtDate(p2T)}</div>
                            <div class="mt-4">
                                <div>Income: <span class="text-success private-data text-xl">${Utils.fmtMoney(p2I)}</span></div>
                                <div>Expenses: <span class="text-danger private-data text-xl">${Utils.fmtMoney(p2S)}</span></div>
                                <div>Net: <span class="private-data text-xl ${p2I-p2S>=0?'text-success':'text-danger'}">${Utils.fmtMoney(Utils.roundMoney(p2I-p2S))}</span></div>
                                <div class="text-sm">Transactions: ${p2Tx.length}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-4">
                        <h3>Summary</h3>
                        <div class="mt-4">
                            <div>Spending Change: <span class="${sDiff>0?'text-danger':'text-success'} private-data">${sDiff>0?'+':''}${Utils.fmtMoney(sDiff)} (${sPct}%)</span></div>
                            <div>Income Change: <span class="${iDiff>=0?'text-success':'text-danger'} private-data">${iDiff>=0?'+':''}${Utils.fmtMoney(iDiff)} (${iPct}%)</span></div>
                        </div>
                    </div>
                `;
            },

            updateDropdowns() {
                const selects = [
                    {el: document.getElementById('filterCategory'), keepFirst: true, items: Store.state.categories, key: 'id', name: 'name'},
                    {el: document.getElementById('txCategory'), keepFirst: false, items: Store.state.categories, key: 'id', name: 'name'},
                    {el: document.getElementById('recurringCategory'), keepFirst: false, items: Store.state.categories, key: 'id', name: 'name'},
                    {el: document.getElementById('filterAccount'), keepFirst: true, items: Store.state.accounts, key: 'id', name: 'name'},
                    {el: document.getElementById('txAccount'), keepFirst: false, items: Store.state.accounts, key: 'id', name: 'name'},
                    {el: document.getElementById('txTransferTo'), keepFirst: false, items: Store.state.accounts, key: 'id', name: 'name'},
                    {el: document.getElementById('recurringAccount'), keepFirst: false, items: Store.state.accounts, key: 'id', name: 'name'}
                ];
                
                selects.forEach(({el, keepFirst, items, key, name}) => {
                    if (!el) return;
                    const current = el.value;
                    const start = keepFirst ? 1 : 0;
                    while (el.options.length > start) el.remove(start);
                    items.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item[key];
                        opt.textContent = item[name];
                        el.appendChild(opt);
                    });
                    if (current && Array.from(el.options).some(o => o.value === current)) el.value = current;
                    else if (el.options.length > 0) el.selectedIndex = 0;
                });
            },

            // ‚úÖ OPTIMIZED: Generic export helper
            exportToCSV(filename, headers, rows) {
                const csv = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csv));
                link.setAttribute("download", `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            exportCSV(type) {
                let txs = type === 'all' ? Store.state.transactions : this.getFilteredTransactions();
                const headers = ["Date", "Description", "Account", "Category", "Type", "Amount (PHP)", "Reconciled"];
                const rows = txs.map(t => {
                    const cat = Utils.getCategoryById(t.category);
                    const acc = Utils.getAccountById(t.accountId);
                    return [
                        t.date,
                        `"${t.desc.replace(/"/g, '""')}"`,
                        acc ? acc.name : "Unknown",
                        cat ? cat.name : "Uncategorized",
                        t.type,
                        Utils.roundMoney(t.amount).toFixed(2), // ‚úÖ FIX: Rounded
                        t.reconciled ? 'Yes' : 'No'
                    ].join(",");
                });
                this.exportToCSV(`zenbudget_${type}`, headers, rows);
            },
            
            exportAccounts() {
                const headers = ["Name", "Type", "Institution", "Balance (PHP)", "Goal Balance", "Low Balance Threshold"];
                const rows = Store.state.accounts.map(a => [
                    `"${a.name}"`, a.type, `"${a.institution || ''}"`,
                    Utils.roundMoney(a.balance).toFixed(2), // ‚úÖ FIX: Rounded
                    a.goalBalance ? Utils.roundMoney(a.goalBalance).toFixed(2) : '',
                    a.lowBalanceThreshold ? Utils.roundMoney(a.lowBalanceThreshold).toFixed(2) : ''
                ].join(","));
                this.exportToCSV('zenbudget_accounts', headers, rows);
            },
            
            exportMonthlyReport() {
                const months = Utils.getMonthlyData();
                const headers = ["Month", "Income (PHP)", "Expenses (PHP)", "Net (PHP)", "Savings Rate (%)"];
                const rows = months.map(m => {
                    const net = Utils.roundMoney(m.income - m.spent); // ‚úÖ FIX: Rounded
                    const rate = m.income > 0 ? ((net / m.income) * 100).toFixed(1) : '0';
                    return [m.label, m.income.toFixed(2), m.spent.toFixed(2), net.toFixed(2), rate].join(",");
                });
                this.exportToCSV('zenbudget_monthly', headers, rows);
            },

            // ‚úÖ NEW: Full backup/restore
            exportFullBackup() {
                const backup = {
                    version: DATA_VERSION,
                    exportDate: new Date().toISOString(),
                    appName: 'ZenBudget Pro',
                    data: Store.state
                };
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `zenbudget_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            },

            importBackup(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        if (!backup.data || !backup.version) {
                            alert('Invalid backup file format');
                            return;
                        }
                        if (confirm('‚ö†Ô∏è This will replace ALL current data. Continue?')) {
                            Store.state = backup.data;
                            Store.state._version = DATA_VERSION;
                            Store.save(false, ['all']);
                            alert('‚úÖ Backup restored successfully!');
                            setTimeout(() => location.reload(), 500);
                        }
                    } catch (error) {
                        alert('Failed to import backup: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        };

        // Initialize
        try {
            App.init();
        } catch (error) {
            console.error('Critical error:', error);
            document.body.innerHTML = '<div class="container" style="margin-top:5rem;"><div class="card error-container"><div class="error-icon">‚ùå</div><h2 class="text-danger">Failed to Initialize</h2><p>Please refresh the page.</p><button class="btn btn-primary mt-4" onclick="location.reload()">Refresh</button></div></div>';
        }
    </script>
</body>
</html>
